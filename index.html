<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- iOS Fullscreen Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Survey App">
    
    <title>Survey Map App</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <!-- Leaflet Rotate Plugin -->
    <script src="https://unpkg.com/leaflet-rotate@0.2.8/dist/leaflet-rotate-src.js"></script>

    <style>
        body { margin:0; padding:0; display:flex; height:100vh; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow:hidden; background:#f0f2f5; flex-direction: column; }
        #map-container { display:none; flex:1; position:relative; }
        #map { width:100%; height:100%; z-index:1; }

        /* GPS Box */
        #gps-coords-box {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            z-index: 9999; background: rgba(0, 0, 0, 0.85);
            color: #00ff00; padding: 8px 15px; border-radius: 20px;
            font-size: 15px; font-family: monospace; font-weight: bold;
            display: none; white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2); pointer-events: none; text-align: center;
        }

        /* Compass / Reset Rotation Button */
        #compass-btn {
            position: absolute; top: 90px; right: 15px; z-index: 3000;
            width: 40px; height: 40px; background: white;
            border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: none; justify-content: center; align-items: center;
            cursor: pointer; transition: opacity 0.3s;
            border: 1px solid #ddd;
        }
        /* The Compass Needle */
        .compass-arrow-container {
            width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;
            transition: transform 0.1s linear; /* Smooth rotation */
        }
        .compass-n {
            width: 0; height: 0;
            border-left: 5px solid transparent; border-right: 5px solid transparent;
            border-bottom: 16px solid #ff3b30; /* Red North */
            position: absolute; top: 4px;
        }
        .compass-s {
            width: 0; height: 0;
            border-left: 5px solid transparent; border-right: 5px solid transparent;
            border-top: 16px solid #8e8e93; /* Grey South */
            position: absolute; bottom: 4px;
        }

        /* User Location Marker */
        .user-location-marker {
            position: relative; width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center;
        }
        .location-dot {
            width: 12px; height: 12px; background-color: #4285F4; border: 2px solid white;
            border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.3); z-index: 2;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .location-beam {
            width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent;
            border-top: 40px solid rgba(66, 133, 244, 0.3); border-radius: 40% 40% 0 0;
            position: absolute; top: -20px; left: 0; transform-origin: center 40px;
            z-index: 1; transition: transform 0.1s linear; display: none;
        }

        /* Home Screen (Blue Theme Restored) */
        #home-screen { 
            flex:1; 
            background: linear-gradient(135deg, #007bff, #0056b3); 
            z-index:9000; 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            padding: 20px; 
            overflow-y: auto; 
        }
        .app-title { 
            color: white; font-size: 28px; font-weight: 800; margin: 40px 0 5px 0; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.2); letter-spacing: 1px;
        }
        .app-subtitle { 
            color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 30px; font-weight: 500;
        }
        
        /* Updated Menu Layout for Folders */
        #menu-container { width: 100%; max-width: 600px; padding-bottom: 40px; }
        
        .folder-container { 
            width: 100%; margin-bottom: 25px; 
            background: rgba(255, 255, 255, 0.15); /* More transparent for blue bg */
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .folder-header { 
            padding: 18px 20px; 
            cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(0,0,0,0.1); /* Darken slightly on blue */
            color: white;
            font-weight: 600;
            font-size: 16px;
        }
        .folder-header span:first-child { display: flex; align-items: center; gap: 10px; }
        
        .folder-content { 
            display: none; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 15px; 
            padding: 20px; 
        }
        .folder-content.open { display: grid; }

        .menu-btn { 
            background: rgba(255,255,255,0.95); 
            border-radius: 12px; 
            height: 90px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            border: none; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        .menu-btn:active { transform: scale(0.96); }
        .menu-btn:hover { box-shadow: 0 8px 15px rgba(0,0,0,0.2); transform: translateY(-2px); }
        
        .menu-text { font-size: 13px; font-weight: 600; color: #333; margin-top:8px; text-align:center; padding: 0 5px; line-height: 1.3; }
        .menu-icon { font-size: 28px; margin-bottom: 2px; display: flex; align-items: center; justify-content: center; }

        /* M_ Specific Folder Style override */
        .folder-container.monitor-folder { border-color: rgba(56, 239, 125, 0.4); }
        .folder-container.monitor-folder .folder-header { background: linear-gradient(90deg, rgba(17, 153, 142, 0.4) 0%, rgba(56, 239, 125, 0.4) 100%); }

        /* Loading & Modals */
        #loading-overlay { display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9500; align-items:center; justify-content:center; color:white; flex-direction:column; }
        .spinner { border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin-bottom:15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #setup-box { display:none; background:white; padding:20px; border-radius:10px; text-align:center; width:80%; max-width:300px; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:9999; box-shadow:0 10px 30px rgba(0,0,0,0.3); }

        /* Floating Buttons (Collapsible) - Top Left */
        .btn-group-container { position:absolute; top:10px; left:10px; z-index:3000; display:flex; flex-direction:column; gap:10px; }
        .btn-expandable { display: none; flex-direction: column; gap: 10px; }
        .btn-expandable.show { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-float { width:44px; height:44px; background:white; border-radius:12px; border:none; box-shadow:0 4px 10px rgba(0,0,0,0.15); font-size:20px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: all 0.2s; color: #333; }
        .btn-float:active { transform: scale(0.95); }
        
        .btn-main-toggle { background: white; color: #333; border: none; z-index: 3001; }
        
        #gps-btn.active { color:#007bff; border:2px solid #007bff; background:#f0f8ff; }
        #batch-toggle-btn.active { background: #ffc107; color: #000; }
        #measure-btn.active { background: #17a2b8; color: white; }
        #zone-btn.active { background: #6610f2; color: white; }

        /* Measurement */
        #measure-box { position: absolute; top: 10px; left: 60px; z-index: 3000; background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 13px; display: none; min-width: 140px; border-left: 4px solid #17a2b8; }
        .measure-btn-small { margin-top:5px; padding:4px 10px; font-size:11px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #eee; font-weight: bold; }

        /* Batch Bar (Map Selection Mode) */
        #batch-bar { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.85); color: white; z-index: 8000; display: none; padding: 10px; box-sizing: border-box; justify-content: space-between; align-items: center; box-shadow: 0 -4px 10px rgba(0,0,0,0.2); flex-wrap: wrap; gap: 8px; }
        .batch-confirm-btn { background: #28a745; color: white; border: none; padding: 8px 14px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 13px; white-space: nowrap; }

        /* Selection Box for Touch Drag */
        .selection-box {
            position: absolute;
            border: 2px dashed #007bff;
            background-color: rgba(0, 123, 255, 0.2);
            z-index: 10000;
            pointer-events: none;
            display: none;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Sidebar & Filters */
        #sidebar { position:absolute; left:0; top:0; bottom:0; width:320px; background:white; z-index:4000; transform:translateX(-100%); transition:transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow:2px 0 20px rgba(0,0,0,0.1); display:flex; flex-direction:column; }
        #sidebar.open { transform:translateX(0); }
        .sidebar-header { background:#007bff; color:white; padding:15px; font-weight:bold; display:flex; justify-content:space-between; align-items:center; font-size:16px; }
        .controls { padding:15px; background:#f8f9fa; display:flex; flex-direction:column; gap:12px; border-bottom:1px solid #ddd; z-index: 10; }
        .filter-row { display:flex; gap:8px; flex-wrap: wrap; }
        .dropdown-check-list { position: relative; flex: 1; min-width: 80px; }
        .dropdown-check-list .anchor { display:block; padding:10px; border:1px solid #ddd; background:white; cursor:pointer; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; border-radius:6px; font-weight: bold; color: #555; }
        .dropdown-check-list .items { display:none; position:absolute; top:100%; left:0; width:100%; background:white; border:1px solid #ddd; max-height:250px; overflow-y:auto; z-index:5000; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 2px; }
        .dropdown-check-list.visible .items { display:block; }
        .check-label { display:flex; padding:10px; border-bottom:1px solid #f5f5f5; font-size:13px; cursor:pointer; align-items:center; }
        .check-label:hover { background: #f0f7ff; }
        .check-label input { margin-right:8px; transform:scale(1.2); accent-color: #007bff; }
        input[type=text] { padding:10px; width:100%; box-sizing:border-box; border:1px solid #ddd; border-radius:6px; outline: none; transition: border 0.2s; }
        input[type=text]:focus { border-color: #007bff; }
        #list-container { flex:1; overflow-y:auto; }
        .list-item { padding:14px; border-bottom:1px solid #f1f1f1; display:flex; justify-content:space-between; cursor:pointer; transition: background 0.1s; }
        .list-item:hover { background: #f9f9f9; }
        .list-item.active { background:#e7f5ff; border-left:5px solid #007bff; }
        .status-dot { width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:8px; border:1px solid rgba(0,0,0,0.1); }
        .triangle-icon { width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 16px solid red; display: inline-block; margin-right: 5px; }
        .damaged-icon { color: red !important; font-weight: 900; font-size: 20px; text-align: center; line-height: 16px; text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff; font-family: Arial, sans-serif; }

        /* Legend */
        .legend { position:absolute; bottom:20px; left:10px; background:rgba(255,255,255,0.95); padding:8px 12px; border-radius:8px; z-index:2000; box-shadow:0 4px 12px rgba(0,0,0,0.15); font-family: -apple-system, Arial, sans-serif; font-size: 11px; display: grid; grid-template-columns: 18px auto; gap: 4px; align-items: center; backdrop-filter: blur(4px); }
        .legend-icon { text-align: center; display: flex; justify-content: center; align-items: center; }
        .legend-text { color: #333; line-height: 1.4; font-weight: 500; }
        .legend-separator { grid-column: 1 / -1; height: 1px; background: #eee; margin: 4px 0; }
        .legend-dot { width:10px; height:10px; border-radius:50%; display:inline-block; border: 1px solid rgba(0,0,0,0.1); }

        /* Modals */
        #update-modal-overlay, #remark-modal-overlay, #initial-modal-overlay, #print-mode-modal, #batch-input-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center; backdrop-filter: blur(2px); }
        .modal-box { background:white; width:85%; max-width:320px; padding:25px; border-radius:16px; color:#333; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-title { margin-top:0; font-size: 18px; font-weight: 700; margin-bottom: 5px; color: #222; }
        .modal-subtitle { font-size:13px; color:#777; margin-bottom:20px; }
        
        .modal-input { width:100%; padding:12px; margin-top:5px; background:#f9f9f9; color:#333; border:1px solid #ddd; border-radius:8px; box-sizing:border-box; outline: none; transition: border 0.2s; font-size: 15px; }
        .modal-input:focus { border-color: #007bff; background: white; }
        textarea.modal-input { height: 100px; resize: none; font-family: sans-serif; }
        
        /* Modal Buttons */
        .modal-btn-row { margin-top:25px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-btn { padding:10px 20px; border:none; border-radius:8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: opacity 0.2s; }
        .modal-btn:active { transform: scale(0.98); }
        .btn-cancel { background: #f0f2f5; color: #555; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #222; }

        .mode-btn { 
            width: 100%; padding: 15px; margin-bottom: 10px; 
            border: 1px solid #eee; border-radius: 10px; 
            background: #f9f9f9; color: #333; font-size: 14px; font-weight: bold;
            cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: left; display: flex; flex-direction: column;
        }
        .mode-btn:active { transform: scale(0.98); }
        .mode-btn.green { border-left: 5px solid #28a745; }
        .mode-btn.blue { border-left: 5px solid #007bff; }
        .mode-btn.orange { border-left: 5px solid #fd7e14; }

        /* Leaflet Overrides */
        .leaflet-tooltip { background: transparent !important; border: none !important; box-shadow: none !important; font-family: Arial, sans-serif; white-space: nowrap; font-weight: 900; }
        .blue-label { color: #0000FF; font-size: 13px; text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff, 1px 1px #fff, -1px -1px #fff; }
        .asbuilt-label { color: #0000FF; font-size: 13px; text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff, 1px 1px #fff, -1px -1px #fff; }
        .leaflet-tooltip-top:before { display:none; }
        
        /* Fixed Zone Boundary Labels */
        .zone-label-icon { background: transparent; overflow: visible; pointer-events: none; }
        .zone-label-text {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.85); border: 2px solid; padding: 4px 12px;
            border-radius: 20px; color: #000; font-weight: 900; font-size: 14px;
            white-space: nowrap; box-shadow: 0 2px 6px rgba(0,0,0,0.3); text-transform: uppercase;
            width: auto; display: inline-block;
        }

        /* Hierarchy Print Report - Table Styled (Optimized) */
        #print-container { 
            display: none; background: white; width: 100%; height: 100%; 
            position: absolute; top: 0; left: 0; z-index: 12000; 
            overflow-y: auto; padding: 20px; box-sizing: border-box; 
        }
        .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        .print-close-btn { position: fixed; top: 10px; right: 10px; background: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: block; }
        .print-action-btn { position: fixed; top: 10px; right: 80px; background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: block; }
        
        /* Level 1: Frequency - LIGHT STYLE */
        .report-freq-block { 
            margin-bottom: 30px; break-inside: avoid; 
            border: 2px solid #000; border-radius: 5px; overflow: hidden; 
        }
        .report-freq-header { 
            background: #fff; /* White Background */
            color: #000;      /* Black Text */
            padding: 10px 15px; 
            font-weight: bold; 
            font-size: 18px; 
            text-transform: uppercase; 
            text-align: center; 
            border-bottom: 2px solid #000;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        /* Level 2 & 3: Type & Points Table - USING CSS TABLES */
        .report-details-table {
            display: table;
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }
        .report-type-row {
            display: table-row;
            border-bottom: 1px solid #000; 
        }
        .report-type-row:last-child {
            border-bottom: none;
        }
        .report-type-cell {
            display: table-cell;
            padding: 8px 12px;
            font-size: 14px;
            border-right: 1px solid #000; /* FORCE RIGHT BORDER */
            border-bottom: 1px solid #000;
            background: #f0f0f0;
            width: 200px; 
            vertical-align: middle;
            font-weight: bold;
            color: #000;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .report-points-cell {
            display: table-cell;
            padding: 8px 12px;
            font-size: 13px;
            font-family: Consolas, monospace;
            color: #000;
            border-bottom: 1px solid #000;
            vertical-align: top;
            line-height: 1.6;
        }

        @media (max-width: 600px) { #sidebar { width:85%; max-width:320px; } .leaflet-top.leaflet-left { top:70px; } }

        /* Print Media Query */
        @media print {
            @page { size: A4; margin: 10mm; }
            body * { visibility: hidden; }
            #print-container, #print-container * { visibility: visible; }
            #print-container { position: absolute; left: 0; top: 0; width: 100%; height: auto; display: block !important; overflow: visible; padding: 0; margin: 0; }
            .print-close-btn, .print-action-btn { display: none !important; }
            
            .report-freq-block { break-inside: avoid; border: 2px solid #000 !important; }
            .report-freq-header { background: #fff !important; color: #000 !important; border-bottom: 2px solid #000 !important; }
            .report-type-cell { border-right: 1px solid #000 !important; border-bottom: 1px solid #000 !important; background: #f0f0f0 !important; }
            .report-points-cell { border-bottom: 1px solid #000 !important; }
        }
    </style>
</head>
<body>

    <div id="home-screen">
        <div class="app-title">Survey Map App</div>
        <div id="status-subtitle" class="app-subtitle">Connecting...</div>
        <!-- Menu Container -->
        <div id="menu-container"></div>
        <div style="margin-top:20px; color:#ddd; font-size:12px; text-decoration:underline; cursor:pointer;" onclick="resetURL()">Reset Connection</div>
    </div>

    <div id="loading-overlay"><div class="spinner"></div><div style="color:white;margin-top:10px">Loading...</div></div>

    <div id="setup-box">
        <h3 class="modal-title">Setup</h3>
        <input type="text" id="url-input" class="modal-input" placeholder="Paste Google Web App URL">
        <div class="modal-btn-row" style="justify-content: center;">
            <button onclick="saveURL()" class="modal-btn btn-primary" style="width:100%">Connect</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="update-modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title" id="modal-title">Update Install Date</h3>
            <div id="modal-subtitle" class="modal-subtitle"></div>
            <label style="font-size:12px;color:#777;">Select Date</label>
            <input type="date" id="install-date-picker" class="modal-input">
            <div class="modal-btn-row">
                <button onclick="closeModal()" class="modal-btn btn-cancel">Cancel</button>
                <button onclick="saveInstall()" class="modal-btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <div id="initial-modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">Update Initial Date</h3>
            <div id="initial-modal-subtitle" class="modal-subtitle"></div>
            <label style="font-size:12px;color:#777;">Initial Date</label>
            <input type="date" id="initial-date-picker" class="modal-input">
            <div class="modal-btn-row">
                <button onclick="closeInitialModal()" class="modal-btn btn-cancel">Cancel</button>
                <button onclick="saveInitial()" class="modal-btn btn-warning">Save</button>
            </div>
        </div>
    </div>

    <div id="remark-modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">Report / Remark</h3>
            <div id="remark-subtitle" class="modal-subtitle"></div>
            <label style="font-size:12px;color:#777;">Details (e.g., Obstructed)</label>
            <textarea id="remark-input" class="modal-input" placeholder="Type here..."></textarea>
            <div class="modal-btn-row">
                <button onclick="closeRemarkModal()" class="modal-btn btn-cancel">Cancel</button>
                <button onclick="saveRemark()" class="modal-btn btn-success">Send</button>
            </div>
        </div>
    </div>
    
    <!-- New M_ Batch Input Modal -->
    <div id="batch-input-modal">
        <div class="modal-box">
            <h3 class="modal-title">Batch Update Monitoring</h3>
            <div class="modal-subtitle">Enter numbers to mark as Checked</div>
            
            <label style="font-size:12px;color:#777;font-weight:bold;">1. Date</label>
            <input type="date" id="batch-input-date" class="modal-input" style="margin-bottom:10px;">
            
            <label style="font-size:12px;color:#777;font-weight:bold;">2. Type</label>
            <select id="batch-input-type" class="modal-input" style="margin-bottom:10px; height:42px;"></select>
            
            <label style="font-size:12px;color:#777;font-weight:bold;">3. Monitoring Point No.</label>
            <div style="font-size:11px;color:#999;margin-bottom:2px;">Format: 1, 3-5, 10 (Matches ID number)</div>
            <input type="text" id="batch-input-text" class="modal-input" placeholder="e.g. 1, 4-6, 12">
            
            <div class="modal-btn-row">
                <button onclick="closeBatchInputModal()" class="modal-btn btn-cancel">Cancel</button>
                <button onclick="processBatchInput()" class="modal-btn btn-success">Update</button>
            </div>
        </div>
    </div>
    
    <!-- New Print Mode Selection Modal -->
    <div id="print-mode-modal">
        <div class="modal-box" style="text-align:center;">
            <h3 class="modal-title">Select Print Mode</h3>
            <div class="modal-subtitle">Choose how to generate the report</div>
            
            <button class="mode-btn green" onclick="loadPrintView('all_simplified')">
                ALL filtered (Simplified)
                <div class="sub-text" style="font-size:11px;margin-top:3px;color:#666;">Combines consecutive IDs (e.g. 01~10)</div>
            </button>
            
            <button class="mode-btn blue" onclick="loadPrintView('all_detailed')">
                ALL filtered (Detailed)
                <div class="sub-text" style="font-size:11px;margin-top:3px;color:#666;">Lists every single ID separately</div>
            </button>
            
            <button class="mode-btn orange" onclick="loadPrintView('view_only')">
                Current Map View Only
                <div class="sub-text" style="font-size:11px;margin-top:3px;color:#666;">Only points visible on screen</div>
            </button>

            <div style="margin-top:15px;">
                <button onclick="closePrintModeModal()" class="modal-btn btn-cancel" style="width:100%">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Hierarchy Print Report Container -->
    <div id="print-container">
        <button class="print-close-btn" onclick="closePrintView()">Close</button>
        <button class="print-action-btn" onclick="window.print()">Print PDF</button>
        <div class="print-header">
            <h2 id="print-title" style="margin:0;">HSK-C5 Instrumentation Record - Monitoring Points Frequency</h2>
            <div id="print-date" style="font-size:12px;color:#666;margin-top:5px;"></div>
        </div>
        <div id="print-content">
            <!-- Hierarchy generated via JS -->
        </div>
    </div>

    <div id="map-container">
        <!-- Compass Reset Button -->
        <div id="compass-btn" onclick="resetNorth()">
            <div class="compass-arrow-container">
                <div class="compass-n"></div>
                <div class="compass-s"></div>
            </div>
        </div>

        <div id="gps-coords-box">Waiting for GPS...</div> 
        
        <div id="measure-box">
            <div style="font-weight:bold; margin-bottom:5px; color:#17a2b8;">Measurement</div>
            <div id="measure-dist" style="font-size:14px; font-weight:bold;">Dist: 0.00 m</div>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <button class="measure-btn-small" onclick="undoMeasure()" style="flex:1;">Undo</button>
                <button class="measure-btn-small" onclick="clearMeasure()" style="flex:1;">Clear</button>
            </div>
        </div>

        <!-- Collapsible Button Group -->
        <div class="btn-group-container">
            <button class="btn-float btn-main-toggle" onclick="toggleMenu()" title="Toggle Menu">‚öôÔ∏è</button>
            <div id="expandable-btns" class="btn-expandable">
                <button class="btn-float" onclick="goHome()" title="Home">üè†</button>
                <button class="btn-float" onclick="toggleSidebar()" title="List/Filter">‚ò∞</button>
                <button class="btn-float" id="gps-btn" onclick="toggleGPS()" title="GPS">üéØ</button>
                <button class="btn-float" id="batch-toggle-btn" onclick="toggleBatchMode()" title="Batch Mode">‚òëÔ∏è</button>
                <button class="btn-float" id="measure-btn" onclick="toggleMeasure()" title="Measure">üìè</button>
                <button class="btn-float" id="zone-btn" onclick="toggleZoneBoundaries()" title="Zone Boundaries">üó∫Ô∏è</button>
                <button class="btn-float" onclick="openPrintView()" title="Print List">üìÑ</button>
                <button class="btn-float" onclick="reloadMap()" title="Reload">üîÑ</button>
            </div>
        </div>

        <div id="sidebar">
            <div class="sidebar-header"><span>Project</span><span onclick="toggleSidebar()" style="cursor:pointer;font-size:24px;">√ó</span></div>
            <div class="controls">
                <div class="filter-row">
                    <div id="zone-dropdown" class="dropdown-check-list" tabindex="100"><span class="anchor" onclick="toggleDropdown('zone')">Zones</span><div class="items" id="zone-items"></div></div>
                    <div id="type-dropdown" class="dropdown-check-list" tabindex="100"><span class="anchor" onclick="toggleDropdown('type')">Types</span><div class="items" id="type-items"></div></div>
                </div>
                <div class="filter-row" style="margin-top:5px;">
                    <div id="status-dropdown" class="dropdown-check-list" tabindex="100"><span class="anchor" onclick="toggleDropdown('status')">Status</span><div class="items" id="status-items"></div></div>
                    <div id="freq-dropdown" class="dropdown-check-list" tabindex="100"><span class="anchor" onclick="toggleDropdown('freq')">Freq</span><div class="items" id="freq-items"></div></div>
                </div>
                <input type="text" id="search-input" placeholder="Search ID..." onkeyup="applyFilter()" style="margin-top:5px;">
            </div>
            <div id="list-container"></div>
        </div>
        
        <div id="map"></div>
        
        <div id="batch-bar">
            <div style="display:flex; align-items:center;">
                <div style="margin-right:15px;">Selected: <span id="batch-count" style="font-weight:bold;color:#ffc107">0</span></div>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <button class="batch-confirm-btn" id="touch-select-btn" onclick="toggleTouchSelect()" style="background:#6c757d;">Draw Box (Touch)</button>
                <button class="batch-confirm-btn" onclick="selectAllVisible()" style="background:#17a2b8;">Select Visible</button>
                <button class="batch-confirm-btn" id="batch-confirm-btn" type="button" onclick="openBatchInstallModal()">Install Selected</button>
            </div>
        </div>

        <div id="legend-container" class="legend">
             <!-- Dynamically populated legend -->
        </div>
    </div>

    <script>
        // Inject Manifest dynamically for PWA Standalone Mode
        var manifest = {
            "name": "Survey Map App",
            "short_name": "SurveyMap",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f0f2f5",
            "theme_color": "#007bff",
            "icons": [
                {
                    "src": "https://cdn-icons-png.flaticon.com/512/854/854878.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        var stringManifest = JSON.stringify(manifest);
        var blob = new Blob([stringManifest], {type: 'application/json'});
        var manifestURL = URL.createObjectURL(blob);
        var link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);

        var API_URL = localStorage.getItem("bsm_api_url");
        var currentSheet = "", map, markers = [], currentEditingId = null;
        var batchMode = false, batchSelection = new Set(), isBatchInstall = false;
        var measureMode = false, measurePoints = [], measureLayerGroup = L.layerGroup();
        var userMarker = null; 
        
        // Touch Select Vars
        var touchSelectActive = false;
        var touchStartPoint = null;
        var selectionBox = null;
        
        // Zone Boundary vars
        var zoneLayerGroup = L.layerGroup();
        var showZones = false;
        var isMonitoringMode = false; // "M_" prefix flag

        var colorNotInstalled = '#FF0000';
        var colorInstalled = '#00e600';
        var colorMonitoring = '#fd7e14';
        var colorAsBuilt = '#9C27B0';
        
        var distinctColors = [
            '#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', 
            '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', 
            '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000', 
            '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080'
        ];
        
        var controlTypes = new Set(["Benchmark", "Control Point", "Check Point", "I & M Control point", "TBM"]);
        
        var HK1980_DEF = "+proj=tmerc +lat_0=22.31213333333334 +lon_0=114.1785555555556 +k=1 +x_0=836694.05 +y_0=819069.8 +ellps=intl +towgs84=-162.619,-276.959,-161.764,0.067753,-2.24365,-1.15883,-1.09425 +units=m +no_defs";
        if (typeof proj4 !== 'undefined') {
            proj4.defs("EPSG:2326", HK1980_DEF);
        }

        window.onload = function() {
            if(!API_URL) { document.getElementById('loading-overlay').style.display = 'none'; document.getElementById('setup-box').style.display = 'block'; } 
            else { 
                fetchSheetNames(); 
            }
            document.addEventListener('click', function(e) { if (!e.target.closest('.dropdown-check-list')) document.querySelectorAll('.dropdown-check-list').forEach(el => el.classList.remove('visible')); });
        };

        function saveURL() { var input = document.getElementById('url-input').value.trim(); if(input) { localStorage.setItem("bsm_api_url", input); API_URL = input; document.getElementById('setup-box').style.display = 'none'; document.getElementById('loading-overlay').style.display = 'flex'; fetchSheetNames(); } }
        function resetURL() { localStorage.removeItem("bsm_api_url"); localStorage.removeItem("bsm_last_sheet"); localStorage.removeItem("bsm_map_center"); localStorage.removeItem("bsm_map_zoom"); location.reload(); }

        function fetchSheetNames() {
            fetch(API_URL, {method: 'POST', body: JSON.stringify({action: 'get_sheet_names'})})
            .then(res => res.json()).then(names => {
                var menuContainer = document.getElementById('menu-container'); menuContainer.innerHTML = "";
                if(names.length === 0) { alert("No sheets found!"); return; }

                // Separate Sheets into Folders
                var iSheets = names.filter(n => n.startsWith("I_"));
                var mSheets = names.filter(n => n.startsWith("M_"));
                var otherSheets = names.filter(n => !n.startsWith("I_") && !n.startsWith("M_"));

                // Helper to create folder
                function createFolder(title, sheets, prefixToRemove, extraClass, itemIconContent) {
                    if (sheets.length === 0) return;
                    
                    var folder = document.createElement('div');
                    folder.className = 'folder-container ' + (extraClass || '');
                    
                    var header = document.createElement('div');
                    header.className = 'folder-header';
                    header.innerHTML = `<span>üìÇ ${title}</span><span>‚ñº</span>`;
                    header.onclick = function() {
                        var c = folder.querySelector('.folder-content');
                        c.classList.toggle('open');
                        header.children[1].innerText = c.classList.contains('open') ? '‚ñ≤' : '‚ñº';
                    };
                    
                    var content = document.createElement('div');
                    content.className = 'folder-content';
                    // Open by default
                    content.classList.add('open');
                    header.children[1].innerText = '‚ñ≤';

                    sheets.forEach(name => {
                        var displayName = prefixToRemove ? name.replace(prefixToRemove, '') : name;
                        var btn = document.createElement('button'); 
                        btn.className = 'menu-btn'; 
                        btn.onclick = function() { loadProject(name); }; 
                        
                        // Default icon if none provided
                        var iconHtml = itemIconContent ? itemIconContent : 'üìÑ';
                        
                        btn.innerHTML = `<div class="menu-icon">${iconHtml}</div><span class="menu-text">${displayName}</span>`; 
                        content.appendChild(btn);
                    });
                    
                    folder.appendChild(header);
                    folder.appendChild(content);
                    menuContainer.appendChild(folder);
                }

                // Installation Folder: Uses ‚öôÔ∏è icon
                createFolder("Installation", iSheets, "I_", "", "‚öôÔ∏è");
                
                // Monitoring Folder: Uses üìà icon
                createFolder("Monitoring", mSheets, "M_", "monitor-folder", "üìà");
                
                if(otherSheets.length > 0) createFolder("Other Sheets", otherSheets, "");

                document.getElementById('status-subtitle').innerText = "Select Project Folder"; document.getElementById('loading-overlay').style.display = 'none';
                
                // AUTO RESTORE STATE
                var lastSheet = localStorage.getItem("bsm_last_sheet");
                if (lastSheet && names.includes(lastSheet)) {
                    loadProject(lastSheet, true);
                }

            }).catch(err => { document.getElementById('loading-overlay').style.display = 'none'; alert("Connection Failed!"); document.getElementById('setup-box').style.display = 'block'; });
        }

        function loadProject(sheetName, isRestoring) {
            currentSheet = sheetName;
            isMonitoringMode = sheetName.startsWith("M_");
            localStorage.setItem("bsm_last_sheet", sheetName); 
            
            document.getElementById('loading-overlay').style.display = 'flex';
            fetch(API_URL, {method: 'POST', body: JSON.stringify({action: 'get_data', sheet: sheetName})})
            .then(res => res.json()).then(data => {
                if(data.length > 0 && data[0].error) { alert(data[0].msg); return; }
                document.getElementById('home-screen').style.display = 'none'; document.getElementById('map-container').style.display = 'block';
                
                initMap(data, isRestoring); 
                updateLegend(); // Update legend based on mode
                
                document.getElementById('loading-overlay').style.display = 'none'; 
                setTimeout(() => map.invalidateSize(), 300);
            }).catch(err => { document.getElementById('loading-overlay').style.display = 'none'; alert("Failed to load map data."); });
        }
        
        function updateLegend() {
            var legend = document.getElementById('legend-container');
            if (isMonitoringMode) {
                // M_ Sheet Legend
                legend.innerHTML = `
                    <div class="legend-icon"><span class="legend-dot" style="background:red;"></span></div>
                    <div class="legend-text">Missing</div>
                    
                    <div class="legend-icon"><span class="legend-dot" style="background:#fd7e14;"></span></div>
                    <div class="legend-text">Partial</div>

                    <div class="legend-icon"><span class="legend-dot" style="background:#00e600;"></span></div>
                    <div class="legend-text">Done</div>

                    <div class="legend-separator"></div>
                    <div class="legend-icon"><span style="color:red;font-weight:900;font-size:12px;">‚úñ&#xFE0E;</span></div>
                    <div class="legend-text">Damaged</div>
                `;
            } else {
                // I_ Sheet Legend (Default)
                legend.innerHTML = `
                    <div class="legend-icon"><span class="legend-dot" style="background:red;"></span></div>
                    <div class="legend-text">Not Installed</div>
                    
                    <div class="legend-icon"><span class="legend-dot" style="background:#00e600;"></span></div>
                    <div class="legend-text">Installed</div>
                    
                    <div class="legend-separator"></div>
                    <div class="legend-icon"><span style="color:red;font-weight:900;font-size:12px;">‚úñ&#xFE0E;</span></div>
                    <div class="legend-text">Damaged</div>
                    
                    <div class="legend-separator"></div>
                    <div class="legend-icon"><span class="legend-dot" style="background:transparent; border: 2px dashed black;"></span></div>
                    <div class="legend-text">As-built</div>
                `;
            }
        }

        function goHome() { 
            document.getElementById('map-container').style.display = 'none';
            document.getElementById('home-screen').style.display = 'flex'; 
            
            // Correct logic to turn off features if active
            if (batchMode) toggleBatchMode(); 
            if (measureMode) toggleMeasure();
            if (gpsActive) toggleGPS();
            
            updateBatchUI();
            
            localStorage.removeItem("bsm_last_sheet");
        }
        function reloadMap() { if(currentSheet) loadProject(currentSheet, true); }

        function toggleMenu() {
            var el = document.getElementById('expandable-btns');
            el.classList.toggle('show');
            var icon = document.querySelector('.btn-main-toggle');
            icon.innerHTML = el.classList.contains('show') ? '‚úñ' : '‚öôÔ∏è';
        }

        function initMap(data, isRestoring) {
            if(map) map.remove();
           map = L.map('map', {
               rotate: true, 
               touchRotate: true,
               zoomControl: false,
               zoomSnap: 0.1,         
               zoomDelta: 0.5,      
               wheelPxPerZoomLevel: 120,
               maxZoom: 24 
           });
            
            var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 24, maxNativeZoom: 19 });
            var satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 24, maxNativeZoom: 19 });
            osmLayer.addTo(map);
            L.control.layers({"Standard": osmLayer, "Satellite": satLayer}).addTo(map);
            L.control.zoom({position: 'bottomright'}).addTo(map);
            
            // Touch Select Events
            var mapContainer = map.getContainer();
            mapContainer.addEventListener('touchstart', handleTouchStart, {passive: false});
            mapContainer.addEventListener('touchmove', handleTouchMove, {passive: false});
            mapContainer.addEventListener('touchend', handleTouchEnd);
            
            // Create selection box element
            if (!selectionBox) {
                selectionBox = document.createElement('div');
                selectionBox.className = 'selection-box';
                mapContainer.appendChild(selectionBox);
            }

            // Map Rotate Event for Compass
            map.on('rotate', function() {
                var bearing = map.getBearing();
                var btn = document.getElementById('compass-btn');
                var arrow = document.querySelector('.compass-arrow-container');
                if (Math.abs(bearing) > 0.5) { // Threshold
                    btn.style.display = 'flex';
                    arrow.style.transform = `rotate(${-bearing}deg)`;
                } else {
                    btn.style.display = 'none';
                }
            });

            // Range Selection logic (Shift+Drag)
            map.on('boxzoomend', function(e) {
                if (batchMode) {
                    processBoxSelection(e.boxZoomBounds);
                }
            });

            map.on('moveend', function() {
                var c = map.getCenter();
                var z = map.getZoom();
                localStorage.setItem("bsm_map_center", JSON.stringify([c.lat, c.lng]));
                localStorage.setItem("bsm_map_zoom", z);
            });

            map.on('click', function(e) {
                if (measureMode) { addMeasurePoint(e.latlng); map.closePopup(); } 
            });

            var bounds = L.latLngBounds();
            var uZones = new Set(), uTypes = new Set(), uFreq = new Set();
            markers = [];
            
            // Get today's date for M_ calculation
            var today = new Date();
            var year = today.getFullYear();
            var month = ('0' + (today.getMonth() + 1)).slice(-2);
            var day = ('0' + today.getDate()).slice(-2);
            var todayStr = year + '-' + month + '-' + day;
            
            data.forEach(p => {
                // Calculate dates for filter logic
                var hasInstallDate = (p.d && p.d.trim() !== "" && p.d !== "-");
                var hasInitDate = (p.init && p.init.trim() !== "" && p.init !== "-");
                var visibleInM = true;

                // M_ Mode Filter: Hide points without Install AND Initial date
                if (isMonitoringMode) {
                    if (!hasInstallDate && !hasInitDate) visibleInM = false; 
                }

                // Filter logic prep - Always add to Zone set
                uZones.add(p.z || "Other");
                
                // Type Logic
                if (controlTypes.has(p.t)) uTypes.add("Control Point"); else uTypes.add(p.t || "Other");
                
                // Frequency Filter Logic: Don't add "None" for M_ mode
                if (p.freq && p.freq !== "None") {
                    uFreq.add(p.freq);
                }
                
                var finalN, finalE, isAsBuilt = false;
                if (p.an && p.ae && !isNaN(p.an) && !isNaN(p.ae)) { finalN = p.an; finalE = p.ae; isAsBuilt = true; }
                else if (p.pn && p.pe && !isNaN(p.pn) && !isNaN(p.pe)) { finalN = p.pn; finalE = p.pe; }
                else { return; }

                var lat = 0, lng = 0;
                try {
                    var wgs = proj4("EPSG:2326", "EPSG:4326", [finalE, finalN]);
                    lat = wgs[1]; lng = wgs[0];
                } catch(e) { console.log("Proj error", e); return; }

                bounds.extend([lat, lng]);

                var isControl = controlTypes.has(p.t);
                var isDamaged = p.dmg === true;
                
                var color = colorNotInstalled; 
                var statusStr = "Not Installed";

                // --- NEW LOGIC FOR MONITORING SHEETS (M_) ---
                if (isMonitoringMode) {
                    if (isDamaged) {
                        statusStr = "Damaged"; color = "red";
                    } else if (isControl) {
                         statusStr = "Control"; color = "#FF0000";
                    } else {
                        // Calculate M Status
                        var checks = p.mChecks || [];
                        var checkCount = checks.filter(c => c === 'v').length;
                        var freq = p.freq;

                        if (freq === 'Daily') {
                             var todayIndex = -1;
                             if (p.mDates) {
                                 todayIndex = p.mDates.indexOf(todayStr);
                             }
                             if (todayIndex > -1 && checks[todayIndex] === 'v') {
                                 statusStr = "Done"; color = "#00e600";
                             } else {
                                 statusStr = "Missing"; color = "red";
                             }
                        } else if (freq === 'Twice a week') {
                            if (checkCount >= 2) {
                                statusStr = "Done"; color = "#00e600";
                            } else if (checkCount === 1) {
                                statusStr = "Partial"; color = "#fd7e14"; 
                            } else {
                                statusStr = "Missing"; color = "red";
                            }
                        } else if (freq === 'Weekly') {
                             if (checkCount >= 1) {
                                statusStr = "Done"; color = "#00e600";
                            } else {
                                statusStr = "Missing"; color = "red";
                            }
                        } else {
                            statusStr = "Missing"; color = "red";
                        }
                    }
                } 
                // --- SIMPLIFIED LOGIC FOR I_ SHEETS ---
                else {
                    if (isDamaged) { statusStr = "Damaged"; color = "red"; }
                    else if (isControl) { statusStr = "Control"; color = "#FF0000"; }
                    else {
                        if (hasInstallDate) { color = colorInstalled; statusStr = "Installed"; }
                    }
                }
                
                var marker;
                if (isDamaged) {
                    var xIcon = L.divIcon({ className: 'damaged-icon', html: '‚úñ&#xFE0E;', iconSize: [16, 16], iconAnchor: [8, 8] });
                    marker = L.marker([lat, lng], { icon: xIcon });
                }
                else if (isControl) {
                    var triIcon = L.divIcon({ className: '', html: '<div class="triangle-icon"></div>', iconSize: [16, 16], iconAnchor: [8, 8] });
                    marker = L.marker([lat, lng], { icon: triIcon });
                } else {
                    var r = isAsBuilt ? 8 : 7; 
                    var opts = { radius: r, fillColor: color, color: 'white', weight: 2, fillOpacity: 1 };
                    if (isAsBuilt) { opts.color = 'black'; opts.dashArray = '5, 5'; }
                    marker = L.circleMarker([lat, lng], opts);
                }
                
                var lblClass = isAsBuilt ? 'asbuilt-label' : 'blue-label';
                marker.bindTooltip(String(p.id), { permanent: true, direction: 'top', offset: [0, 5], className: lblClass });
                marker.bindPopup("Loading...");

                // Enhanced Click Handler to prevent stale closure data and support consistent selection
                marker.on('click', function(e) {
                    if (measureMode) {
                        e.target.closePopup();
                        addMeasurePoint(e.latlng);
                    } else if (batchMode) {
                        e.target.closePopup();
                        // Retrieve the LATEST marker object from the global array to ensure status is current
                        var mObj = markers.find(x => x.id === String(p.id));
                        if (mObj && isEligibleForSelection(mObj)) {
                            toggleBatchSelection(mObj.id);
                        }
                    } else {
                        var currentM = markers.find(x => x.id === String(p.id));
                        if(currentM) {
                             var popupHtml = generatePopupHtml(currentM);
                             e.target.setPopupContent(popupHtml);
                        }
                    }
                });

                markers.push({ 
                    id: String(p.id), 
                    zone: String(p.z||"Other"), 
                    type: String(p.t||"Other"), 
                    status: statusStr,
                    isControl: isControl,
                    isDamaged: isDamaged,
                    color: color,
                    layer: marker,
                    installDate: p.d || '-', initDate: p.init || '-', 
                    code: p.code, rl: p.rl, lat: lat, lng: lng, n: finalN, e: finalE, isAsBuilt: isAsBuilt,
                    remark: p.rmk || "",
                    freq: p.freq || "None",
                    hasValidDate: visibleInM
                });
            });

            if (isRestoring) {
                var savedCenter = localStorage.getItem("bsm_map_center");
                var savedZoom = localStorage.getItem("bsm_map_zoom");
                if (savedCenter && savedZoom) {
                    try { map.setView(JSON.parse(savedCenter), parseFloat(savedZoom)); } catch(e) { if(markers.length > 0) map.fitBounds(bounds.pad(0.1)); }
                } else { if(markers.length > 0) map.fitBounds(bounds.pad(0.1)); }
            } else { if(markers.length > 0) map.fitBounds(bounds.pad(0.1)); }

            setupMultiFilters(uZones, uTypes, uFreq);
            applyFilter();
            
            // Re-apply batch selection highlights if we just reloaded in batch mode
            if (batchMode && batchSelection.size > 0) {
                batchSelection.forEach(id => {
                    var m = markers.find(x => x.id === id);
                    if (m && m.layer.setStyle) { 
                        m.layer.setStyle({ fillColor: '#ffc107', color: 'black', weight: 4 }); 
                    }
                });
            }
        }

        // --- Compass Reset ---
        function resetNorth() {
            if(map) map.setBearing(0);
        }

        // --- Convex Hull & Zone Boundary Logic ---
        function toggleZoneBoundaries() {
            showZones = !showZones;
            var btn = document.getElementById('zone-btn');
            if (showZones) { 
                btn.classList.add('active'); 
                drawZoneBoundaries(); // Calc and draw when enabled
                map.addLayer(zoneLayerGroup); 
            } else { 
                btn.classList.remove('active'); 
                map.removeLayer(zoneLayerGroup); 
            }
        }

        function getZoneColor(zoneStr) {
            var hash = 0;
            for (var i = 0; i < zoneStr.length; i++) hash = zoneStr.charCodeAt(i) + ((hash << 5) - hash);
            var index = Math.abs(hash) % distinctColors.length;
            return distinctColors[index];
        }
        
        function calculateCentroid(points) {
            var latSum = 0, lngSum = 0;
            points.forEach(p => { latSum += p.lat; lngSum += p.lng; });
            return [latSum / points.length, lngSum / points.length];
        }

        function drawZoneBoundaries() {
            zoneLayerGroup.clearLayers();
            var uniqueZones = new Set();
            markers.forEach(m => { if(m.zone && m.zone !== "Other") uniqueZones.add(m.zone); });

            uniqueZones.forEach(z => {
                var points = [];
                markers.forEach(m => { if (m.zone === z || m.zone.indexOf(z + '/') === 0) points.push({lat: m.lat, lng: m.lng}); });
                if (points.length < 3) return; 

                var hull = convexHull(points);
                var latlngs = hull.map(p => [p.lat, p.lng]);
                var color = getZoneColor(z);

                L.polygon(latlngs, { color: color, weight: 4, opacity: 0.9, fillColor: color, fillOpacity: 0.15, interactive: false }).addTo(zoneLayerGroup);

                var centroid = calculateCentroid(points); 
                var labelText = z.toString().toLowerCase().includes('zone') ? z : 'Zone ' + z;
                var labelIcon = L.divIcon({ className: 'zone-label-icon', html: `<div class="zone-label-text" style="color:${color};border-color:${color}">${labelText}</div>`, iconSize: [0, 0], iconAnchor: [0, 0] });
                L.marker(centroid, {icon: labelIcon, zIndexOffset: 10000, interactive: false}).addTo(zoneLayerGroup);
            });
        }

        function convexHull(points) {
            var pts = points.slice();
            pts.sort((a, b) => a.lat != b.lat ? a.lat - b.lat : a.lng - b.lng);
            var lower = [];
            for (var i = 0; i < pts.length; i++) {
                while (lower.length >= 2 && crossProduct(lower[lower.length - 2], lower[lower.length - 1], pts[i]) <= 0) lower.pop();
                lower.push(pts[i]);
            }
            var upper = [];
            for (var i = pts.length - 1; i >= 0; i--) {
                while (upper.length >= 2 && crossProduct(upper[upper.length - 2], upper[upper.length - 1], pts[i]) <= 0) upper.pop();
                upper.push(pts[i]);
            }
            upper.pop(); lower.pop();
            return lower.concat(upper);
        }
        function crossProduct(o, a, b) { return (a.lng - o.lng) * (b.lat - o.lat) - (a.lat - o.lat) * (b.lng - o.lng); }

        // --- NEW Hierarchy Report View Logic ---
        function openPrintView() { document.getElementById('print-mode-modal').style.display = 'flex'; }
        function closePrintModeModal() { document.getElementById('print-mode-modal').style.display = 'none'; }
        function loadPrintView(mode) { closePrintModeModal(); document.getElementById('print-container').style.display = 'block'; refreshPrintContent(mode); }
        
        function refreshPrintContent(mode) {
            var contentDiv = document.getElementById('print-content');
            var dateEl = document.getElementById('print-date');
            if (!mode) mode = 'all_simplified';
            dateEl.innerText = "Generated on: " + new Date().toLocaleString();
            contentDiv.innerHTML = "";
            var visibleMarkers = markers.filter(m => map.hasLayer(m.layer));
            if (mode === 'view_only') { var bounds = map.getBounds(); visibleMarkers = visibleMarkers.filter(m => bounds.contains(m.layer.getLatLng())); }
            if (visibleMarkers.length === 0) { contentDiv.innerHTML = "<div style='text-align:center;margin-top:20px;'>No points found.</div>"; return; }

            var byFreq = {};
            visibleMarkers.forEach(m => { var f = m.freq || "No Frequency"; if(!byFreq[f]) byFreq[f] = []; byFreq[f].push(m); });
            
            Object.keys(byFreq).sort().forEach(freqName => {
                var freqPoints = byFreq[freqName];
                var freqBlock = document.createElement('div'); freqBlock.className = 'report-freq-block';
                var freqHeader = document.createElement('div'); freqHeader.className = 'report-freq-header';
                freqHeader.innerText = `${freqName} (Total: ${freqPoints.length})`; freqBlock.appendChild(freqHeader);
                var byType = {};
                freqPoints.forEach(p => { var t = p.type || "Other"; if(!byType[t]) byType[t] = []; byType[t].push(p.id); });

                var detailsContainer = document.createElement('div'); detailsContainer.className = 'report-details-table';
                Object.keys(byType).sort().forEach(typeName => {
                    var ids = byType[typeName].sort();
                    var row = document.createElement('div'); row.className = 'report-type-row';
                    var typeCell = document.createElement('div'); typeCell.className = 'report-type-cell'; typeCell.innerText = `${typeName} (${ids.length})`;
                    var pointsCell = document.createElement('div'); pointsCell.className = 'report-points-cell';
                    if (mode === 'all_simplified') pointsCell.innerHTML = simplifyIdList(ids);
                    else pointsCell.innerHTML = ids.map(id => `<span style="display:inline-block; white-space:nowrap;">${id}</span>`).join(', ');
                    row.appendChild(typeCell); row.appendChild(pointsCell); detailsContainer.appendChild(row);
                });
                freqBlock.appendChild(detailsContainer); contentDiv.appendChild(freqBlock);
            });
        }
        
        function simplifyIdList(ids) {
            if (ids.length === 0) return "";
            var groups = {}, singles = [];
            ids.forEach(id => {
                var match = id.match(/^(.*?)(\d+)$/);
                if (match) {
                    var prefix = match[1], num = parseInt(match[2], 10), digitCount = match[2].length;
                    if (!groups[prefix]) groups[prefix] = [];
                    groups[prefix].push({ num: num, digitCount: digitCount, original: id });
                } else singles.push(id);
            });
            var results = [];
            for (var prefix in groups) {
                var items = groups[prefix].sort((a, b) => a.num - b.num);
                if (items.length === 0) continue;
                var start = items[0], prev = items[0];
                for (var i = 1; i < items.length; i++) {
                    var curr = items[i];
                    if (curr.num === prev.num + 1 && curr.digitCount === prev.digitCount) prev = curr;
                    else { results.push(formatRange(start, prev)); start = curr; prev = curr; }
                }
                results.push(formatRange(start, prev));
            }
            results.push(...singles);
            return results.join(', ');
        }
        function formatRange(start, end) { return start.original === end.original ? `<span style="display:inline-block; white-space:nowrap;">${start.original}</span>` : `<span style="display:inline-block; white-space:nowrap;">${start.original} ~ ${end.original}</span>`; }
        function closePrintView() { document.getElementById('print-container').style.display = 'none'; }

        // --- Filter Logic ---
        function toggleDropdown(t) { var el = document.getElementById(t+'-dropdown'); document.querySelectorAll('.dropdown-check-list').forEach(d => { if(d!==el) d.classList.remove('visible'); }); el.classList.toggle('visible'); }
        
        function setupMultiFilters(z, t, f) { 
            // Feature 2: Remove OTHER from I_ mode AND M_ mode ZONE filter (Always Remove)
            z.delete("Other");
            
            populate(z, 'zone', 'Zone'); 
            populate(t, 'type', 'Type'); 
            
            // Branch: Hide FREQ filter in I_ mode
            var freqEl = document.getElementById('freq-dropdown');
            if (isMonitoringMode) {
                freqEl.style.display = 'block';
                populate(f, 'freq', 'Freq');
            } else {
                freqEl.style.display = 'none';
            }
            
            // Dynamic Status List
            var sSet;
            if (isMonitoringMode) {
                 sSet = new Set(['Missing', 'Partial', 'Done', 'Damaged']);
            } else {
                 sSet = new Set(['Not Installed', 'Installed', 'Damaged']); 
            }
            populate(sSet, 'status', 'Status'); 
        }

        function populate(set, type, label) { 
            var c = document.getElementById(type+'-items');
            c.innerHTML=`<li class="check-label" onclick="toggleAll('${type}',this)"><input type="checkbox" id="all-${type}"><b>Select All</b></li>`; 
            var saved = localStorage.getItem('filter_' + type);
            var savedArr = saved ? JSON.parse(saved) : null;
            var allChecked = true;
            Array.from(set).sort().forEach(v => { 
                var isChecked = savedArr ? savedArr.includes(v) : true;
                if(!isChecked) allChecked = false;
                c.innerHTML+=`<li class="check-label" onclick="updateFilter('${type}')"><input type="checkbox" class="${type}-chk" value="${v}" ${isChecked?'checked':''}>${v}</li>`;
            });
            document.getElementById('all-'+type).checked = allChecked;
            document.getElementById(type+'-dropdown').setAttribute('data-label', label);
            updateAnchor(type);
        }
        function toggleAll(t, el) { var chk = el.querySelector('input').checked; document.querySelectorAll('.'+t+'-chk').forEach(c=>c.checked=chk); updateFilter(t); }
        function updateFilter(t) { 
            var chks = Array.from(document.querySelectorAll('.'+t+'-chk'));
            var checkedVals = chks.filter(c=>c.checked).map(c=>c.value);
            localStorage.setItem('filter_' + t, JSON.stringify(checkedVals));
            document.getElementById('all-'+t).checked = chks.every(c=>c.checked); 
            updateAnchor(t); applyFilter();
        }
        function updateAnchor(t) { 
            var chk = document.querySelectorAll('.'+t+'-chk:checked').length;
            var tot = document.querySelectorAll('.'+t+'-chk').length;
            var anchor = document.querySelector('#'+t+'-dropdown .anchor');
            var label = document.getElementById(t+'-dropdown').getAttribute('data-label') || t;
            if (chk === tot) anchor.innerHTML = label + ": All"; else if (chk === 0) anchor.innerHTML = label + ": None"; else anchor.innerHTML = label + ": " + chk;
        }
        
        function applyFilter() {
            var s = document.getElementById('search-input').value.toUpperCase();
            var sz = Array.from(document.querySelectorAll('.zone-chk:checked')).map(c => c.value);
            var st = Array.from(document.querySelectorAll('.type-chk:checked')).map(c => c.value);
            var ss = Array.from(document.querySelectorAll('.status-chk:checked')).map(c => c.value);
            var sf = Array.from(document.querySelectorAll('.freq-chk:checked')).map(c => c.value);
            
            var v=[];
            markers.forEach(m => {
                var searchMatch = m.id.toUpperCase().includes(s);
                var isControl = controlTypes.has(m.type);
                
                // --- Priority 1: Control Point Logic (M_ Mode or General) ---
                if (isControl) {
                    // Control Points only respect TYPE Filter & Search
                    var typeSelected = st.includes("Control Point") || st.includes(m.type);
                    
                    if (typeSelected && searchMatch) { 
                        map.addLayer(m.layer); 
                        v.push(m); 
                    } else {
                        map.removeLayer(m.layer); 
                    }
                    // IMPORTANT: Return early so no other filters apply to Control Points
                    return; 
                }

                // --- Priority 2: M_ Mode Visibility Logic ---
                // Hide non-control points without valid dates
                if (isMonitoringMode && !m.hasValidDate) {
                    map.removeLayer(m.layer);
                    return; 
                }

                // --- Priority 3: Standard Filtering ---
                var typeMatch = st.includes(m.type);
                var zoneMatch = sz.includes(m.zone);
                // FREQ Filter Check: If in I_ mode (freq hidden), ignore freq filter
                var freqMatch = isMonitoringMode ? sf.includes(m.freq) : true;
                var statusMatch = ss.includes(m.status);

                if (typeMatch && zoneMatch && statusMatch && freqMatch && searchMatch) { map.addLayer(m.layer); v.push(m); } 
                else { map.removeLayer(m.layer); }
            });
            renderList(v);
        }

        // --- Batch Mode ---
        function toggleBatchMode() {
            if (measureMode) toggleMeasure(); // Close Measure if open
            
            batchMode = !batchMode;
            var btn = document.getElementById('batch-toggle-btn');
            var bar = document.getElementById('batch-bar');
            
            if (batchMode) { 
                btn.classList.add('active'); 
                bar.style.display = 'flex'; 
                map.closePopup(); 
                
                // Update button text contextually
                var confirmBtn = document.getElementById('batch-confirm-btn');
                if (confirmBtn) {
                    confirmBtn.innerText = isMonitoringMode ? "Update Status" : "Install Selected";
                }
                
            } else { 
                btn.classList.remove('active'); 
                bar.style.display = 'none'; 
                clearBatchSelection(); 
                
                // Also turn off touch select if active
                if (touchSelectActive) toggleTouchSelect();
            }
        }
        
        function updateBatchUI() { 
            var btn = document.getElementById('batch-toggle-btn'); 
            var bar = document.getElementById('batch-bar'); 
            if(batchMode){ btn.classList.add('active'); bar.style.display='flex'; } else { btn.classList.remove('active'); bar.style.display='none'; } 
        }

        function toggleBatchSelection(id) {
            var m = markers.find(x => x.id === id);
            if (!m) return;
            if (batchSelection.has(id)) {
                batchSelection.delete(id);
                if (m.layer.setStyle) { m.layer.setStyle({ fillColor: m.color, color: (m.id === m.zone ? 'white':'white'), weight: 2 }); }
            } else {
                batchSelection.add(id);
                if (m.layer.setStyle) { m.layer.setStyle({ fillColor: '#ffc107', color: 'black', weight: 4 }); }
            }
            document.getElementById('batch-count').innerText = batchSelection.size;
        }
        function clearBatchSelection() {
            batchSelection.forEach(id => { var m = markers.find(x => x.id === id); if (m && m.layer.setStyle) m.layer.setStyle({ fillColor: m.color, color: 'white', weight: 2 }); });
            batchSelection.clear(); document.getElementById('batch-count').innerText = 0;
        }
        
        // Select Visible Helper for "Range" Selection
        function selectAllVisible() {
            if (!batchMode) return;
            var bounds = map.getBounds();
            var addedCount = 0;
            markers.forEach(m => {
                if (map.hasLayer(m.layer) && bounds.contains(m.layer.getLatLng())) {
                    if (isEligibleForSelection(m)) {
                        if (!batchSelection.has(m.id)) {
                            toggleBatchSelection(m.id);
                            addedCount++;
                        }
                    }
                }
            });
        }
        
        function isEligibleForSelection(m) {
            if (isMonitoringMode) {
                if (m.status !== "Done" && m.status !== "Damaged") return true;
            } else {
                if (m.status === "Not Installed") return true;
            }
            return false;
        }
        
        // --- Touch Box Selection Logic ---
        function toggleTouchSelect() {
            touchSelectActive = !touchSelectActive;
            var btn = document.getElementById('touch-select-btn');
            
            if (touchSelectActive) {
                btn.style.background = '#ffc107';
                btn.style.color = 'black';
                map.dragging.disable();
                map.touchZoom.disable();
                map.scrollWheelZoom.disable();
            } else {
                btn.style.background = '#6c757d';
                btn.style.color = 'white';
                map.dragging.enable();
                map.touchZoom.enable();
                map.scrollWheelZoom.enable();
                // Clear any leftover box
                if (selectionBox) selectionBox.style.display = 'none';
            }
        }
        
        function handleTouchStart(e) {
            if (!touchSelectActive || e.touches.length !== 1) return;
            
            // Prevent interference with UI buttons
            if (e.target.closest('.batch-confirm-btn') || e.target.closest('#batch-bar')) return;

            var touch = e.touches[0];
            var mapRect = map.getContainer().getBoundingClientRect();
            
            // Relative coordinates
            touchStartPoint = { 
                x: touch.clientX - mapRect.left, 
                y: touch.clientY - mapRect.top 
            };
            
            selectionBox.style.left = touchStartPoint.x + 'px';
            selectionBox.style.top = touchStartPoint.y + 'px';
            selectionBox.style.width = '0px';
            selectionBox.style.height = '0px';
            selectionBox.style.display = 'block';
            
            e.preventDefault(); 
        }
        
        function handleTouchMove(e) {
            if (!touchSelectActive || !touchStartPoint || e.touches.length !== 1) return;
            var touch = e.touches[0];
            var mapRect = map.getContainer().getBoundingClientRect();
            
            var currentX = touch.clientX - mapRect.left;
            var currentY = touch.clientY - mapRect.top;
            
            var width = Math.abs(currentX - touchStartPoint.x);
            var height = Math.abs(currentY - touchStartPoint.y);
            var left = Math.min(currentX, touchStartPoint.x);
            var top = Math.min(currentY, touchStartPoint.y);
            
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';
            selectionBox.style.left = left + 'px';
            selectionBox.style.top = top + 'px';
            
            e.preventDefault();
        }

        function handleTouchEnd(e) {
            if (!touchSelectActive || !touchStartPoint) return;
            
            var rect = selectionBox.getBoundingClientRect();
            var mapRect = map.getContainer().getBoundingClientRect();
            
            var tlX = rect.left - mapRect.left;
            var tlY = rect.top - mapRect.top;
            var brX = rect.right - mapRect.left;
            var brY = rect.bottom - mapRect.top;

            if (rect.width > 5 && rect.height > 5) {
                // Use pixel-based selection with tolerance
                selectMarkersInPixelRect({
                    minX: tlX, minY: tlY, maxX: brX, maxY: brY
                });
            }
            
            selectionBox.style.display = 'none';
            touchStartPoint = null;
        }

        // Shared function for pixel-based selection
        function selectMarkersInPixelRect(rect) {
            markers.forEach(m => {
                if (map.hasLayer(m.layer)) {
                    if (isEligibleForSelection(m)) {
                        var pt = map.latLngToContainerPoint(m.layer.getLatLng());
                        var radius = 15; // Tolerance radius (pixels) to allow easier selection
                        
                        if (pt.x >= rect.minX - radius && pt.x <= rect.maxX + radius &&
                            pt.y >= rect.minY - radius && pt.y <= rect.maxY + radius) {
                            if (!batchSelection.has(m.id)) toggleBatchSelection(m.id);
                        }
                    }
                }
            });
        }

        // Update processBoxSelection to also use pixel logic (for consistency)
        function processBoxSelection(bounds) {
            var p1 = map.latLngToContainerPoint(bounds.getNorthWest());
            var p2 = map.latLngToContainerPoint(bounds.getSouthEast());
            
            var minX = Math.min(p1.x, p2.x);
            var maxX = Math.max(p1.x, p2.x);
            var minY = Math.min(p1.y, p2.y);
            var maxY = Math.max(p1.y, p2.y);
            
            selectMarkersInPixelRect({
                minX: minX, minY: minY, maxX: maxX, maxY: maxY
            });
        }

        // --- M_ Mode Batch Input Logic (Preserved for compatibility but currently unused via map flow) ---
        function openBatchInputModal() {
            var modal = document.getElementById('batch-input-modal');
            var typeSelect = document.getElementById('batch-input-type');
            var dateInput = document.getElementById('batch-input-date');
            
            // 1. Date (Today)
            dateInput.value = new Date().toISOString().split('T')[0];
            
            // 2. Populate Types
            typeSelect.innerHTML = "";
            var types = new Set();
            markers.forEach(m => types.add(m.type));
            Array.from(types).sort().forEach(t => {
                // Feature 1: Exclude Control Points
                if (controlTypes.has(t)) return;
                
                var opt = document.createElement('option');
                opt.value = t;
                opt.innerText = t;
                typeSelect.appendChild(opt);
            });
            
            // Reset Text
            document.getElementById('batch-input-text').value = "";
            
            modal.style.display = 'flex';
        }

        function closeBatchInputModal() {
            document.getElementById('batch-input-modal').style.display = 'none';
        }

        function processBatchInput() {
            var type = document.getElementById('batch-input-type').value;
            var text = document.getElementById('batch-input-text').value.trim();
            var date = document.getElementById('batch-input-date').value;

            if (!type || !text || !date) { alert("Please fill all fields"); return; }

            // Parse text numbers
            var numbers = new Set();
            var parts = text.split(/[,\s]+/); // split by comma or space
            
            parts.forEach(part => {
                if (part.includes('-')) {
                    // Range
                    var range = part.split('-');
                    if (range.length === 2) {
                        var start = parseInt(range[0], 10);
                        var end = parseInt(range[1], 10);
                        if (!isNaN(start) && !isNaN(end)) {
                            for (var i = start; i <= end; i++) numbers.add(i);
                        }
                    }
                } else {
                    // Single number
                    var num = parseInt(part, 10);
                    if (!isNaN(num)) numbers.add(num);
                }
            });

            if (numbers.size === 0) { alert("No valid numbers found"); return; }

            // Match IDs
            var matchedIds = [];
            markers.forEach(m => {
                if (m.type === type) {
                    var match = m.id.match(/(\d+)$/);
                    if (match) {
                        var idNum = parseInt(match[1], 10);
                        if (numbers.has(idNum)) {
                            if (m.status !== 'Done') {
                                matchedIds.push(m.id);
                            }
                        }
                    }
                }
            });

            if (matchedIds.length === 0) { alert("No matching eligible points found (Points might already be Done)."); return; }

            if (!confirm(`Found ${matchedIds.length} eligible points. Confirm update?`)) return;

            // Submit to Backend (Reuse existing logic)
            // Temporarily populate batchSelection so submitBatchInstallData works
            batchSelection.clear();
            matchedIds.forEach(id => batchSelection.add(id));
            
            closeBatchInputModal();
            submitBatchInstallData(date);
        }

        // --- Measurement ---
        function toggleMeasure() {
            if (batchMode) toggleBatchMode();
            measureMode = !measureMode;
            var btn = document.getElementById('measure-btn');
            var box = document.getElementById('measure-box');
            if (measureMode) { 
                btn.classList.add('active'); 
                box.style.display = 'block'; 
                map.closePopup(); 
                map.getContainer().style.cursor = 'crosshair'; 
                measureLayerGroup.addTo(map); // Add layer ONLY when active
            } else { 
                btn.classList.remove('active'); 
                box.style.display = 'none'; 
                clearMeasure(); 
                map.getContainer().style.cursor = ''; 
                map.removeLayer(measureLayerGroup); // Remove layer when inactive
            }
        }
        function addMeasurePoint(latlng) { measurePoints.push(latlng); redrawMeasure(); calculateMeasure(); }
        function undoMeasure() { if(measurePoints.length > 0) { measurePoints.pop(); redrawMeasure(); calculateMeasure(); } }
        function clearMeasure() { measurePoints = []; measureLayerGroup.clearLayers(); document.getElementById('measure-dist').innerText = "Dist: 0.00 m"; }
        function redrawMeasure() {
            measureLayerGroup.clearLayers();
            if(measurePoints.length === 0) return;
            measurePoints.forEach(pt => { L.circleMarker(pt, {color: '#17a2b8', fillColor: 'white', radius: 5, fillOpacity: 1, weight: 2}).addTo(measureLayerGroup); });
            if (measurePoints.length > 1) { L.polyline(measurePoints, {color: '#17a2b8', dashArray: '5, 5', weight: 3}).addTo(measureLayerGroup); }
        }
        function calculateMeasure() {
            if (measurePoints.length < 2) { document.getElementById('measure-dist').innerText = "Dist: 0.00 m"; return; }
            var totalDist = 0;
            for (var i = 0; i < measurePoints.length - 1; i++) { totalDist += measurePoints[i].distanceTo(measurePoints[i+1]); }
            document.getElementById('measure-dist').innerText = "Dist: " + totalDist.toFixed(2) + " m";
        }

        // --- Actions ---
        function toggleDamaged(id, isMarkingDamaged) {
            if(!confirm(isMarkingDamaged ? "Mark as DAMAGED?" : "Reinstate (Fix) this point?")) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            fetch(API_URL, {
                method: 'POST', body: JSON.stringify({action: 'toggle_damaged', sheet: currentSheet, id: id, status: (isMarkingDamaged?'damaged':'fixed')})
            }).then(res => res.text()).then(txt => { reloadMap(); });
        }

        var gpsActive = false, gpsWatchId = null, currentHeading = 0;
        function handleOrientation(event) {
            var heading = null;
            if (event.webkitCompassHeading) heading = event.webkitCompassHeading;
            else if (event.alpha !== null) heading = 360 - event.alpha;
            if (heading !== null) {
                heading = (heading + 360) % 360; currentHeading = heading;
                var beam = document.querySelector('.location-beam'); if (beam) { beam.style.display = 'block'; beam.style.transform = `rotate(${heading}deg)`; }
                if(gpsActive) updateGPSBoxContent();
            }
        }
        if (window.DeviceOrientationEvent) { window.addEventListener("deviceorientation", handleOrientation, true); window.addEventListener("deviceorientationabsolute", handleOrientation, true); }

        function updateGPSBoxContent(lat, lon, acc) {
             var box = document.getElementById('gps-coords-box'); var content = "";
             if (lat !== undefined && lon !== undefined) {
                 try {
                    if (typeof proj4 !== 'undefined') {
                        var result = proj4("EPSG:4326", "EPSG:2326", [lon, lat]);
                        content += `N: ${result[1].toFixed(3)} | E: ${result[0].toFixed(3)}`;
                        if(acc) content += ` <br><small>Á≤æÂ∫¶: ¬±${Math.round(acc)}m</small>`;
                    } else content += `Lat: ${lat.toFixed(5)} | Lon: ${lon.toFixed(5)}`;
                 } catch(e) { content += `Lat: ${lat.toFixed(5)} | Lon: ${lon.toFixed(5)}`; }
                 box.setAttribute('data-last-pos', content);
             } else content = box.getAttribute('data-last-pos') || "Waiting...";
             if (currentHeading !== null && !isNaN(currentHeading)) content += ` | ‚¨Ü ${Math.round(currentHeading)}¬∞`;
             box.innerHTML = content;
        }

        function toggleGPS() {
            var gpsBtn = document.getElementById('gps-btn'), gpsBox = document.getElementById('gps-coords-box');
            if (!gpsActive) {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') DeviceOrientationEvent.requestPermission().catch(console.error);
                if ("geolocation" in navigator) {
                    gpsBtn.classList.add('active'); gpsBox.style.display = 'block'; gpsBox.innerHTML = "Ê≠£Âú®Áç≤ÂèñË°õÊòüË®äËôü..."; gpsActive = true;
                    gpsWatchId = navigator.geolocation.watchPosition(function(position) {
                            var lat = position.coords.latitude, lon = position.coords.longitude, latlng = [lat, lon];
                            if (!userMarker) {
                                var beamIcon = L.divIcon({ className: 'user-location-marker', html: '<div class="location-beam"></div><div class="location-dot"></div>', iconSize: [40, 40], iconAnchor: [20, 20] });
                                userMarker = L.marker(latlng, {icon: beamIcon, zIndexOffset: 1000}).addTo(map);
                            } else userMarker.setLatLng(latlng);
                            map.setView(latlng); updateGPSBoxContent(lat, lon, position.coords.accuracy);
                        },
                        function(error) { gpsBox.innerHTML = "GPS Error: " + error.message; }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else alert("ÁÄèË¶ΩÂô®‰∏çÊîØÊåÅ GPS");
            } else {
                if(gpsWatchId !== null) navigator.geolocation.clearWatch(gpsWatchId);
                gpsWatchId = null; gpsBtn.classList.remove('active'); gpsBox.style.display = 'none'; gpsActive = false; if(userMarker) map.removeLayer(userMarker); userMarker = null;
            }
        }

        function openInstallModal(id) { 
            isBatchInstall = false; currentEditingId = id; 
            document.getElementById('modal-title').innerText = "Update Install Date"; document.getElementById('modal-subtitle').innerText = id;
            var today = new Date().toISOString().split('T')[0]; document.getElementById('install-date-picker').value = today;
            document.getElementById('update-modal-overlay').style.display = 'flex';
        }
        function closeModal() { document.getElementById('update-modal-overlay').style.display = 'none'; currentEditingId = null; isBatchInstall = false; }
        
        function saveInstall() { 
            var d = document.getElementById('install-date-picker').value; if(!d) { alert("Please select date"); return; } 
            if (isBatchInstall) submitBatchInstallData(d); else { if(!currentEditingId) return; updateStatus(currentEditingId, d); }
            closeModal();
        }

        function updateStatus(id, dateStr) { 
            var m = markers.find(x => x.id === id);
            if(m) {
                m.status = "Installed"; m.color = colorInstalled; m.installDate = dateStr; 
                if(m.layer.setStyle) m.layer.setStyle({fillColor: colorInstalled}); 
                updatePopupContent(m); 
            }
            fetch(API_URL, {method:'POST', body:JSON.stringify({action:'update', sheet:currentSheet, id:id, status:1, date:dateStr})})
            .catch(err => alert("Update Error (Background)"));
        }

        function openInitialModal(id) {
            currentEditingId = id; document.getElementById('initial-modal-subtitle').innerText = "ID: " + id;
            var today = new Date().toISOString().split('T')[0]; document.getElementById('initial-date-picker').value = today;
            document.getElementById('initial-modal-overlay').style.display = 'flex';
        }
        function closeInitialModal() { document.getElementById('initial-modal-overlay').style.display = 'none'; currentEditingId = null; }
        function saveInitial() {
            var dateInput = document.getElementById('initial-date-picker').value; if (!dateInput) { alert("Please select date"); return; }
            document.getElementById('loading-overlay').style.display = 'flex';
            var id = currentEditingId, m = markers.find(x => x.id === id);
            if(m) { m.initDate = dateInput; m.status = "Monitoring"; m.color = colorMonitoring; if(m.layer.setStyle) m.layer.setStyle({fillColor: colorMonitoring}); updatePopupContent(m); }
            fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'update_initial', sheet: currentSheet, id: id, date: dateInput})
            }).then(res => res.text()).then(txt => { document.getElementById('loading-overlay').style.display = 'none'; }).catch(err => { alert("Update Failed"); document.getElementById('loading-overlay').style.display = 'none'; });
            closeInitialModal();
        }

        function generatePopupHtml(m) {
            var navLink = `<a href="https://www.google.com/maps/dir/?api=1&destination=${m.lat},${m.lng}" target="_blank" title="Navigate" style="text-decoration:none; font-size:16px; margin-left: 8px;">üöÄ</a>`;
            var content = `<div style="font-weight:bold;font-size:16px; display: flex; align-items: center;">${m.id}${navLink}</div><div style="font-size:13px;color:#555;">Code: <b>${m.code || '-'}</b></div><div style="font-size:12px;color:#555;">N: ${m.n} | E: ${m.e}</div><div style="font-size:12px;color:#555;">Zone: ${m.zone} | Type: ${m.type}</div>`;
            if (m.isAsBuilt) content += `<div style="color:blue; text-shadow: 1px 1px 0 #00FF00; font-weight:bold; font-size:12px;">(As-built Pos.)</div>`;
            if (m.freq && m.freq !== "None") content += `<div style="font-size:12px;color:#007bff;">Freq: <b>${m.freq}</b></div>`;
            if (m.isControl) { content += `<div style="margin-top:5px;font-weight:bold;color:#333;">RL: ${m.rl || '-'}</div>`; return content; }

            var btnHtml = "";
            
            // --- Logic Branch: I_ sheets vs M_ sheets
            if (isMonitoringMode) {
                 // M_ mode buttons
                 if (m.isDamaged) {
                     btnHtml = `<button onclick="toggleDamaged('${m.id}', false)" style="width:100%;background:#28a745;color:white;border:none;padding:8px;border-radius:4px;cursor:pointer;margin-top:10px;">Reinstate (Fix)</button>`;
                 } else {
                     // Empty button HTML for normal status in M mode (Removed text)
                     btnHtml = ``;
                 }
            } else {
                 // I_ mode buttons (Original)
                 var hasInstall = (m.installDate && m.installDate !== "-" && m.installDate !== "");
                 var hasInit = (m.initDate && m.initDate !== "-" && m.initDate !== "");
                 if(m.isDamaged) btnHtml = `<button onclick="toggleDamaged('${m.id}', false)" style="width:100%;background:#28a745;color:white;border:none;padding:8px;border-radius:4px;cursor:pointer;margin-top:10px;">Reinstate (Fix)</button>`;
                 else if (!hasInstall) btnHtml = `<button onclick="openInstallModal('${m.id}')" style="width:100%;background:#007bff;color:white;border:none;padding:8px;border-radius:4px;cursor:pointer;margin-top:10px;">Confirm Install</button>`;
                 else if (hasInstall && !hasInit) btnHtml = `<button onclick="openInitialModal('${m.id}')" style="width:100%;background:#e67e22;color:white;border:none;padding:8px;border-radius:4px;cursor:pointer;margin-top:10px;">Input Initial Date</button>`;
                 else btnHtml = `<button disabled style="width:100%;background:#ccc;border:none;padding:8px;border-radius:4px;margin-top:10px;">Locked</button>`;
            }

            var dmgBtn = !m.isDamaged ? `<div style="text-align:right;margin-top:5px;"><small style="color:red;cursor:pointer;text-decoration:underline;" onclick="toggleDamaged('${m.id}', true)">Report Damaged</small></div>` : "";
            var rmkBtn = `<div style="text-align:right;margin-top:2px;"><small style="color:#007bff;cursor:pointer;text-decoration:underline;" onclick="openRemarkModal('${m.id}')">[Remark]</small></div>`;
            var remarkDisplay = "";
            if (m.remark && m.remark.trim() !== "") remarkDisplay = `<div style="margin-top:5px;color:purple;font-size:12px;font-weight:bold;border-top:1px dashed #ccc;padding-top:2px;">Remark: ${m.remark}</div>`;

            content += `<div style="margin-top:8px;border-top:1px solid #eee;padding-top:5px;">Status: <b style="color:${m.color}">${m.status}</b></div>`;
            
            if (!isMonitoringMode) {
                content += `<div style="font-size:11px;color:#777;">Install: ${m.installDate}</div><div style="font-size:11px;color:#777;">Initial: ${m.initDate}</div>`;
            }
            
            content += `${remarkDisplay}${btnHtml}${dmgBtn}${rmkBtn}`;
            return content;
        }

        function updatePopupContent(m) { if (m.layer.getPopup()) m.layer.setPopupContent(generatePopupHtml(m)); }

        function openRemarkModal(id) {
            currentEditingId = id; document.getElementById('remark-subtitle').innerText = "ID: " + id;
            var m = markers.find(x=>x.id===id); document.getElementById('remark-input').value = m ? m.remark : ""; 
            document.getElementById('remark-modal-overlay').style.display = 'flex';
        }
        function closeRemarkModal() { document.getElementById('remark-modal-overlay').style.display = 'none'; currentEditingId = null; }
        function saveRemark() {
            if(!currentEditingId) return; var txt = document.getElementById('remark-input').value;
            document.getElementById('loading-overlay').style.display = 'flex';
            var m = markers.find(x=>x.id===currentEditingId); if(m) { m.remark = txt; updatePopupContent(m); }
            fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'save_remark', sheet: currentSheet, id: currentEditingId, remark: txt})
            }).then(res => res.text()).then(resp => { alert(resp); document.getElementById('loading-overlay').style.display = 'none'; closeRemarkModal();
            }).catch(err => { alert("Error saving remark"); document.getElementById('loading-overlay').style.display = 'none'; });
        }

        function renderList(items) { var c = document.getElementById('list-container'); c.innerHTML='';
            items.forEach(m=>{ 
                var el=document.createElement('div'); el.className='list-item'; 
                var zc= getZoneColor(m.zone); 
                var iconHtml;
                if(m.isDamaged) iconHtml = '<span style="color:red;font-weight:bold;">‚úñ</span>';
                else if(m.isControl) iconHtml = '<div class="triangle-icon"></div>';
                else iconHtml = `<span class="status-dot" style="background:${m.color}"></span>`;
                el.innerHTML=`<div style="display:flex; align-items:center;">${iconHtml} <b>${m.id}</b></div><div><span style="font-size:11px;background:#eee;padding:2px 5px;border-radius:4px;margin-right:5px;">${m.type}</span><span style="font-size:11px;background:${zc};color:white;padding:2px 5px;border-radius:10px;">${m.zone}</span></div>`; 
                el.onclick=()=>{ map.flyTo(m.layer.getLatLng(),18); var popupHtml = generatePopupHtml(m); m.layer.setPopupContent(popupHtml); m.layer.openPopup(); if(window.innerWidth<600)toggleSidebar(false);}; 
                c.appendChild(el); 
            });
        }
        function toggleSidebar(f) { var s=document.getElementById('sidebar'); if(f!==undefined) f?s.classList.add('open'):s.classList.remove('open'); else s.classList.toggle('open'); }
        
        function submitBatchInstallData(dateStr) {
            document.getElementById('loading-overlay').style.display = 'flex';
            var ids = Array.from(batchSelection);
            
            // Optimistic UI Update
            ids.forEach(id => {
                 var m = markers.find(x=>x.id===id);
                 if(m) {
                    if (isMonitoringMode) {
                        m.status = "Done"; m.color = "green"; // Assume done after update
                    } else {
                        m.status = "Installed"; m.color = colorInstalled; m.installDate = dateStr;
                    }
                    if(m.layer.setStyle) m.layer.setStyle({fillColor:m.color});
                     updatePopupContent(m);
                 }
            });
            renderList(markers);
            
            fetch(API_URL, {
                method: 'POST', body: JSON.stringify({action: 'batch_install', sheet: currentSheet, ids: ids, date: dateStr})
            }).then(res => res.text()).then(txt => {
                alert(txt); 
                // Clear selection so UI resets correctly after reload
                clearBatchSelection();
                if(!isMonitoringMode) toggleBatchMode(); 
                reloadMap(); 
            }).catch(err => { alert("Error"); document.getElementById('loading-overlay').style.display = 'none'; });
        }
        
        function openBatchInstallModal() {
            if (batchSelection.size === 0) return;
            isBatchInstall = true;
            
            // Context Aware Titles
            if (isMonitoringMode) {
                document.getElementById('modal-title').innerText = "Batch Update Status";
                document.getElementById('modal-subtitle').innerText = batchSelection.size + " points selected";
            } else {
                document.getElementById('modal-title').innerText = "Batch Install";
                document.getElementById('modal-subtitle').innerText = batchSelection.size + " selected points";
            }
            
            var today = new Date().toISOString().split('T')[0];
            document.getElementById('install-date-picker').value = today; 
            document.getElementById('update-modal-overlay').style.display = 'flex';
        }
    </script>
</body>
</html>
