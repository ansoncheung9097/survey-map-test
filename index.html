<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Survey App">
    
    <title>Survey Map App</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://unpkg.com/leaflet-rotate@0.2.8/dist/leaflet-rotate-src.js"></script>

    <style>
        body { margin:0; padding:0; display:flex; height:100vh; font-family:-apple-system,Arial,sans-serif; overflow:hidden; background:#f0f2f5; flex-direction: column; }
        #map-container { display:none; flex:1; position:relative; }
        #map { width:100%; height:100%; z-index:1; }

        /* GPS Box */
        #gps-coords-box {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            z-index: 9999; background: rgba(0, 0, 0, 0.85);
            color: #00ff00; padding: 8px 15px; border-radius: 20px;
            font-size: 15px; font-family: monospace; font-weight: bold;
            display: none; white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            border: 2px solid #ffffff33; pointer-events: none; text-align: center;
        }

        /* User Location Marker */
        .user-location-marker {
            position: relative; width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center;
        }
        .location-dot {
            width: 12px; height: 12px; background-color: #4285F4; border: 2px solid white;
            border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.3); z-index: 2;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .location-beam {
            width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent;
            border-top: 40px solid rgba(66, 133, 244, 0.3); border-radius: 40% 40% 0 0;
            position: absolute; top: -20px; left: 0; transform-origin: center 40px;
            z-index: 1; transition: transform 0.1s linear; display: none;
        }

        /* Home Screen */
        #home-screen { flex:1; background: linear-gradient(135deg, #007bff, #0056b3); z-index:9000; display:flex; flex-direction:column; align-items:center; padding: 20px; overflow-y: auto; }
        .app-title { color:white; font-size:24px; font-weight:bold; margin:30px 0 10px 0; }
        .app-subtitle { color:rgba(255,255,255,0.8); font-size:14px; margin-bottom:30px; }
        
        /* Updated Menu Layout */
        .menu-section { width: 100%; max-width: 500px; margin-bottom: 20px; }
        .menu-header { color: white; font-size: 16px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 5px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; }
        
        .menu-btn { background: rgba(255,255,255,0.95); border-radius: 12px; height: 85px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.1s; }
        .menu-btn:active { transform: scale(0.95); }
        .menu-text { font-size: 13px; font-weight: bold; color: #333; margin-top:5px; text-align:center; word-break: break-word; padding: 0 5px; }
        .menu-icon { font-size: 28px; }

        /* Loading & Modals */
        #loading-overlay { display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9500; align-items:center; justify-content:center; color:white; flex-direction:column; }
        .spinner { border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin-bottom:15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #setup-box { display:none; background:white; padding:20px; border-radius:10px; text-align:center; width:80%; max-width:300px; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:9999; box-shadow:0 10px 30px rgba(0,0,0,0.3); }

        /* Floating Buttons */
        .btn-group-container { position:absolute; top:10px; left:10px; z-index:3000; display:flex; flex-direction:column; gap:10px; }
        .btn-expandable { display: none; flex-direction: column; gap: 10px; }
        .btn-expandable.show { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-float { width:44px; height:44px; background:white; border-radius:8px; border:none; box-shadow:0 2px 5px rgba(0,0,0,0.3); font-size:20px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: all 0.2s; }
        .btn-float:active { transform: scale(0.95); }
        
        .btn-main-toggle { background: white; color: #333; border: 2px solid #ccc; z-index: 3001; }
        
        #gps-btn.active { color:#007bff; border:2px solid #007bff; background:#eef; }
        #batch-toggle-btn.active { background: #ffc107; color: #000; border: 2px solid #000; }
        #measure-btn.active { background: #17a2b8; color: white; border: 2px solid #0056b3; }
        #zone-btn.active { background: #6610f2; color: white; border: 2px solid white; }

        /* Measurement */
        #measure-box { position: absolute; top: 10px; left: 60px; z-index: 3000; background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 13px; display: none; min-width: 120px; }
        .measure-btn-small { margin-top:5px; padding:3px 8px; font-size:11px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #eee; }

        /* Batch Bar */
        #batch-bar { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.85); color: white; z-index: 8000; display: none; padding: 10px; box-sizing: border-box; justify-content: space-between; align-items: center; }
        .batch-confirm-btn { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }

        /* Sidebar & Filters */
        #sidebar { position:absolute; left:0; top:0; bottom:0; width:320px; background:white; z-index:4000; transform:translateX(-100%); transition:transform 0.3s; box-shadow:2px 0 10px rgba(0,0,0,0.2); display:flex; flex-direction:column; }
        #sidebar.open { transform:translateX(0); }
        .sidebar-header { background:#007bff; color:white; padding:15px; font-weight:bold; display:flex; justify-content:space-between; align-items:center; font-size:16px; }
        .controls { padding:10px; background:#f8f9fa; display:flex; flex-direction:column; gap:10px; border-bottom:1px solid #ddd; z-index: 10; }
        .filter-row { display:flex; gap:5px; flex-wrap: wrap; }
        .dropdown-check-list { position: relative; flex: 1; min-width: 80px; }
        .dropdown-check-list .anchor { display:block; padding:8px; border:1px solid #ccc; background:white; cursor:pointer; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; border-radius:4px; font-weight: bold; }
        .dropdown-check-list .items { display:none; position:absolute; top:100%; left:0; width:100%; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; z-index:5000; }
        .dropdown-check-list.visible .items { display:block; }
        .check-label { display:flex; padding:8px; border-bottom:1px solid #eee; font-size:13px; cursor:pointer; align-items:center; }
        .check-label input { margin-right:5px; transform:scale(1.2); }
        input[type=text] { padding:8px; width:100%; box-sizing:border-box; border:1px solid #ccc; border-radius:4px; }
        #list-container { flex:1; overflow-y:auto; }
        .list-item { padding:12px; border-bottom:1px solid #f1f1f1; display:flex; justify-content:space-between; cursor:pointer; }
        .list-item.active { background:#e7f5ff; border-left:5px solid #007bff; }
        .status-dot { width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:5px; border:1px solid rgba(0,0,0,0.1); }
        .triangle-icon { width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 16px solid red; display: inline-block; margin-right: 5px; }
        .damaged-icon { color: red !important; font-weight: 900; font-size: 20px; text-align: center; line-height: 16px; text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff; font-family: Arial, sans-serif; }

        /* Legend */
        .legend { position:absolute; bottom:15px; left:10px; background:rgba(255,255,255,0.95); padding:6px; border-radius:6px; z-index:2000; box-shadow:0 2px 4px rgba(0,0,0,0.2); font-family: Arial, sans-serif; font-size: 11px; display: grid; grid-template-columns: 15px auto; gap: 2px; align-items: center; }
        .legend-icon { text-align: center; display: flex; justify-content: center; align-items: center; }
        .legend-text { color: #333; line-height: 1.2; }
        .legend-separator { grid-column: 1 / -1; height: 1px; background: #eee; margin: 2px 0; }
        .legend-dot { width:8px; height:8px; border-radius:50%; display:inline-block; }

        /* Modals */
        #update-modal-overlay, #remark-modal-overlay, #initial-modal-overlay, #print-mode-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center; }
        .modal-box { background:#222; width:85%; max-width:320px; padding:20px; border-radius:12px; color:white; }
        .modal-input { width:100%; padding:10px; margin-top:5px; background:#444; color:white; border:1px solid #555; border-radius:6px; box-sizing:border-box; }
        textarea.modal-input { height: 80px; resize: none; font-family: sans-serif; }

        .mode-btn { 
            width: 100%; padding: 15px; margin-bottom: 10px; 
            border: 1px solid #555; border-radius: 8px; 
            background: #333; color: white; font-size: 14px; font-weight: bold;
            cursor: pointer; transition: background 0.2s; 
        }
        .mode-btn:active { transform: scale(0.98); }
        .mode-btn.green { background: #28a745; border-color: #1e7e34; }
        .mode-btn.blue { background: #007bff; border-color: #0056b3; }
        .mode-btn.orange { background: #fd7e14; border-color: #e36209; }

        /* Leaflet Overrides */
        .leaflet-tooltip { background: transparent !important; border: none !important; box-shadow: none !important; font-family: Arial, sans-serif; white-space: nowrap; font-weight: 900; }
        .blue-label { color: #0000FF; font-size: 13px; text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff, 1px 1px #fff, -1px -1px #fff; }
        .asbuilt-label { color: #0000FF; font-size: 13px; text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff, 1px 1px #fff, -1px -1px #fff; }
        .leaflet-tooltip-top:before { display:none; }
        
        .zone-label-icon { background: transparent; overflow: visible; pointer-events: none; }
        .zone-label-text {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.85); border: 2px solid; padding: 4px 12px;
            border-radius: 20px; color: #000; font-weight: 900; font-size: 14px;
            white-space: nowrap; box-shadow: 0 2px 6px rgba(0,0,0,0.3); text-transform: uppercase;
            width: auto; display: inline-block;
        }

        /* Hierarchy Print Report */
        #print-container { 
            display: none; background: white; width: 100%; height: 100%; 
            position: absolute; top: 0; left: 0; z-index: 12000; 
            overflow-y: auto; padding: 20px; box-sizing: border-box; 
        }
        .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        .print-close-btn { position: fixed; top: 10px; right: 10px; background: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: block; }
        .print-action-btn { position: fixed; top: 10px; right: 80px; background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: block; }
        
        .report-freq-block { margin-bottom: 30px; break-inside: avoid; border: 2px solid #000; border-radius: 5px; overflow: hidden; }
        .report-freq-header { background: #fff; color: #000; padding: 10px 15px; font-weight: bold; font-size: 18px; text-transform: uppercase; text-align: center; border-bottom: 2px solid #000; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .report-details-table { display: table; width: 100%; border-collapse: collapse; background: #fff; }
        .report-type-row { display: table-row; border-bottom: 1px solid #000; }
        .report-type-row:last-child { border-bottom: none; }
        .report-type-cell { display: table-cell; padding: 8px 12px; font-size: 14px; border-right: 1px solid #000; border-bottom: 1px solid #000; background: #f0f0f0; width: 200px; vertical-align: middle; font-weight: bold; color: #000; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .report-points-cell { display: table-cell; padding: 8px 12px; font-size: 13px; font-family: Consolas, monospace; color: #000; border-bottom: 1px solid #000; vertical-align: top; line-height: 1.6; }

        @media (max-width: 600px) { #sidebar { width:85%; max-width:320px; } .leaflet-top.leaflet-left { top:70px; } }

        @media print {
            @page { size: A4; margin: 10mm; }
            body * { visibility: hidden; }
            #print-container, #print-container * { visibility: visible; }
            #print-container { position: absolute; left: 0; top: 0; width: 100%; height: auto; display: block !important; overflow: visible; padding: 0; margin: 0; }
            .print-close-btn, .print-action-btn { display: none !important; }
            .report-freq-block { break-inside: avoid; border: 2px solid #000 !important; }
            .report-freq-header { background: #fff !important; color: #000 !important; border-bottom: 2px solid #000 !important; }
            .report-type-cell { border-right: 1px solid #000 !important; border-bottom: 1px solid #000 !important; background: #f0f0f0 !important; }
            .report-points-cell { border-bottom: 1px solid #000 !important; }
        }
    </style>
</head>
<body>

    <div id="home-screen">
        <div class="app-title">Survey Map App</div>
        <div id="status-subtitle" style="color:white;margin-bottom:20px">Connecting...</div>
        
        <div id="menu-container" style="width:100%; display:flex; flex-direction:column; align-items:center;">
             <div class="menu-section" id="section-instr" style="display:none;">
                 <div class="menu-header">üìÇ INSTRUMENTATION</div>
                 <div class="menu-grid" id="grid-instr"></div>
             </div>
             
             <div class="menu-section" id="section-mon" style="display:none;">
                 <div class="menu-header" style="color:#ffc107;">üìä MONITORING RECORD</div>
                 <div class="menu-grid" id="grid-mon"></div>
             </div>
        </div>

        <div style="margin-top:20px; color:#ccc; font-size:12px; text-decoration:underline;" onclick="resetURL()">Reset Connection</div>
    </div>

    <div id="loading-overlay"><div class="spinner"></div><div style="color:white;margin-top:10px">Loading...</div></div>

    <div id="setup-box">
        <h3>Setup</h3>
        <input type="text" id="url-input" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="Paste Google Web App URL">
        <button onclick="saveURL()" style="background:#007bff; color:white; padding:10px 20px; border:none; border-radius:5px;">Connect</button>
    </div>

    <div id="update-modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0" id="modal-title">Update Install Date</h3>
            <div id="modal-subtitle" style="font-size:13px;color:#ccc;margin-bottom:15px"></div>
            
            <label id="date-label" style="font-size:12px;color:#ccc;">Select Date</label>
            <input type="date" id="install-date-picker" class="modal-input">

            <div style="margin-top:20px; text-align:right;">
                <button onclick="closeModal()" style="padding:8px 15px; background:#555; color:white; border:none; border-radius:5px;">Cancel</button>
                <button id="modal-save-btn" onclick="saveInstall()" style="padding:8px 15px; background:#0044cc; color:white; border:none; border-radius:5px;">Save</button>
            </div>
        </div>
    </div>

    <div id="initial-modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0">Update Initial Date</h3>
            <div id="initial-modal-subtitle" style="font-size:13px;color:#ccc;margin-bottom:15px"></div>
            <label style="font-size:12px;color:#ccc;">Initial Date</label>
            <input type="date" id="initial-date-picker" class="modal-input">
            <div style="margin-top:20px; text-align:right;">
                <button onclick="closeInitialModal()" style="padding:8px 15px; background:#555; color:white; border:none; border-radius:5px;">Cancel</button>
                <button onclick="saveInitial()" style="padding:8px 15px; background:#e67e22; color:white; border:none; border-radius:5px;">Save</button>
            </div>
        </div>
    </div>

    <div id="remark-modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0">Report / Remark</h3>
            <div id="remark-subtitle" style="font-size:13px;color:#ccc;margin-bottom:15px"></div>
            <label style="font-size:12px;color:#ccc;">Details (e.g., Obstructed)</label>
            <textarea id="remark-input" class="modal-input" placeholder="Type here..."></textarea>
            <div style="margin-top:20px; text-align:right;">
                <button onclick="closeRemarkModal()" style="padding:8px 15px; background:#555; color:white; border:none; border-radius:5px;">Cancel</button>
                <button onclick="saveRemark()" style="padding:8px 15px; background:#28a745; color:white; border:none; border-radius:5px;">Send</button>
            </div>
        </div>
    </div>
    
    <div id="print-mode-modal">
        <div class="modal-box" style="text-align:center;">
            <h3 style="margin-top:0">Select Print Mode</h3>
            <div style="font-size:13px;color:#ccc;margin-bottom:20px">Choose how to generate the report</div>
            <button class="mode-btn green" onclick="loadPrintView('all_simplified')">ALL filtered (Simplified)<div class="sub-text" style="font-size:11px;margin-top:3px;">Combines consecutive IDs</div></button>
            <button class="mode-btn blue" onclick="loadPrintView('all_detailed')">ALL filtered (Detailed)<div class="sub-text" style="font-size:11px;margin-top:3px;">Lists every single ID</div></button>
            <button class="mode-btn orange" onclick="loadPrintView('view_only')">Current Map View Only<div class="sub-text" style="font-size:11px;margin-top:3px;">Only points visible on screen</div></button>
            <div style="margin-top:15px;"><button onclick="closePrintModeModal()" style="padding:8px 15px; background:#555; color:white; border:none; border-radius:5px;">Cancel</button></div>
        </div>
    </div>

    <div id="print-container">
        <button class="print-close-btn" onclick="closePrintView()">Close</button>
        <button class="print-action-btn" onclick="window.print()">Print PDF</button>
        <div class="print-header"><h2 id="print-title" style="margin:0;">HSK-C5 Instrumentation Record - Monitoring Points Frequency</h2><div id="print-date" style="font-size:12px;color:#666;margin-top:5px;"></div></div>
        <div id="print-content"></div>
    </div>

    <div id="map-container">
        <div id="gps-coords-box">Waiting for GPS...</div> 
        <div id="measure-box"><div style="font-weight:bold; margin-bottom:5px;">Measurement</div><div id="measure-dist">Dist: 0.00 m</div><button class="measure-btn-small" onclick="undoMeasure()">Undo</button><button class="measure-btn-small" onclick="clearMeasure()">Clear All</button></div>

        <div class="btn-group-container">
            <button class="btn-float btn-main-toggle" onclick="toggleMenu()" title="Toggle Menu">‚öôÔ∏è</button>
            <div id="expandable-btns" class="btn-expandable">
                <button class="btn-float" onclick="goHome()" title="Home">üè†</button>
                <button class="btn-float" onclick="toggleSidebar()" title="List/Filter">‚ò∞</button>
                <button class="btn-float" id="gps-btn" onclick="toggleGPS()" title="GPS">üéØ</button>
                <button class="btn-float" id="batch-toggle-btn" onclick="toggleBatchMode()" title="Batch Mode">‚òëÔ∏è</button>
                <button class="btn-float" id="measure-btn" onclick="toggleMeasure()" title="Measure">üìè</button>
                <button class="btn-float" id="zone-btn" onclick="toggleZoneBoundaries()" title="Zone Boundaries">üó∫Ô∏è</button>
                <button class="btn-float" onclick="openPrintView()" title="Print List">üìÑ</button>
                <button class="btn-float" onclick="reloadMap()" title="Reload">üîÑ</button>
            </div>
        </div>

        <div id="sidebar">
            <div class="sidebar-header"><span>Project</span><span onclick="toggleSidebar()" style="cursor:pointer;font-size:24px;">√ó</span></div>
            <div class="controls">
                <div class="filter-row">
                    <div id="zone-dropdown" class="dropdown-check-list" tabindex="100"><span class="anchor" onclick="toggleDropdown('zone')">Zones</span><div class="items" id="zone-items"></div></div>
                    <div id="type-dropdown" class="dropdown-check-list" tabindex="100"><span class="anchor" onclick="toggleDropdown('type')">Types</span><div class="items" id="type-items"></div></div>
                </div>
                <div class="filter-row" style="margin-top:5px;">
                    <div id="status-dropdown" class="dropdown-check-list" tabindex="100"><span class="anchor" onclick="toggleDropdown('status')">Status</span><div class="items" id="status-items"></div></div>
                    <div id="freq-dropdown" class="dropdown-check-list" tabindex="100"><span class="anchor" onclick="toggleDropdown('freq')">Freq</span><div class="items" id="freq-items"></div></div>
                </div>
                <input type="text" id="search-input" placeholder="Search ID..." onkeyup="applyFilter()" style="margin-top:5px;">
            </div>
            <div id="list-container"></div>
        </div>
        
        <div id="map"></div>
        
        <div id="batch-bar">
            <div>Selected: <span id="batch-count" style="font-weight:bold;color:#ffc107">0</span></div>
            <button class="batch-confirm-btn" onclick="openBatchInstallModal()">Install Selected</button>
        </div>

        <div class="legend" id="legend-box">
            </div>
    </div>

    <script>
        var manifest = { "name": "Survey Map App", "short_name": "SurveyMap", "start_url": ".", "display": "standalone", "background_color": "#f0f2f5", "theme_color": "#007bff", "icons": [ { "src": "https://cdn-icons-png.flaticon.com/512/854/854878.png", "sizes": "512x512", "type": "image/png" } ] };
        var stringManifest = JSON.stringify(manifest);
        var blob = new Blob([stringManifest], {type: 'application/json'});
        var manifestURL = URL.createObjectURL(blob);
        var link = document.createElement('link'); link.rel = 'manifest'; link.href = manifestURL; document.head.appendChild(link);

        var API_URL = localStorage.getItem("bsm_api_url");
        var currentSheet = "", map, markers = [], currentEditingId = null;
        var batchMode = false, batchSelection = new Set(), isBatchInstall = false;
        var measureMode = false, measurePoints = [], measureLayerGroup = L.layerGroup();
        var userMarker = null; 
        
        var zoneLayerGroup = L.layerGroup();
        var showZones = false; // Default OFF
        
        // Default Colors (Instrumentation)
        var colorNotInstalled = '#FF0000';
        var colorInstalled = '#00e600';
        var colorMonitoring = '#fd7e14';
        
        // Monitoring Colors
        var monColorMissing = '#FF0000'; // Red
        var monColorPartial = '#fd7e14'; // Orange
        var monColorDone = '#00e600';    // Green
        
        var distinctColors = ['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080'];
        var controlTypes = new Set(["Benchmark", "Control Point", "Check Point", "I & M Control point", "TBM"]);
        
        var HK1980_DEF = "+proj=tmerc +lat_0=22.31213333333334 +lon_0=114.1785555555556 +k=1 +x_0=836694.05 +y_0=819069.8 +ellps=intl +towgs84=-162.619,-276.959,-161.764,0.067753,-2.24365,-1.15883,-1.09425 +units=m +no_defs";
        if (typeof proj4 !== 'undefined') proj4.defs("EPSG:2326", HK1980_DEF);

        window.onload = function() {
            if(!API_URL) { document.getElementById('loading-overlay').style.display = 'none'; document.getElementById('setup-box').style.display = 'block'; } 
            else { fetchSheetNames(); }
            document.addEventListener('click', function(e) { if (!e.target.closest('.dropdown-check-list')) document.querySelectorAll('.dropdown-check-list').forEach(el => el.classList.remove('visible')); });
        };

        function saveURL() { var input = document.getElementById('url-input').value.trim(); if(input) { localStorage.setItem("bsm_api_url", input); API_URL = input; document.getElementById('setup-box').style.display = 'none'; document.getElementById('loading-overlay').style.display = 'flex'; fetchSheetNames(); } }
        function resetURL() { localStorage.removeItem("bsm_api_url"); localStorage.removeItem("bsm_last_sheet"); localStorage.removeItem("bsm_map_center"); localStorage.removeItem("bsm_map_zoom"); location.reload(); }

        // --- Fetch & Display Sheet Names with Clean UI (Hide I_ & M_) ---
        function fetchSheetNames() {
            fetch(API_URL, {method: 'POST', body: JSON.stringify({action: 'get_sheet_names'})})
            .then(res => res.json())
            .then(names => {
                var gridInstr = document.getElementById('grid-instr');
                var gridMon = document.getElementById('grid-mon');
                var secInstr = document.getElementById('section-instr');
                var secMon = document.getElementById('section-mon');
                
                gridInstr.innerHTML = ""; gridMon.innerHTML = "";
                
                if(names.length === 0) { alert("No sheets found!"); return; }
                if(names.result === "Error") { alert("Script Error: " + names.message); return; }

                var hasInstr = false, hasMon = false;

                names.forEach(name => {
                    var btn = document.createElement('button');
                    btn.className = 'menu-btn';
                    btn.onclick = function() { loadProject(name); };
                    
                    if (name.startsWith("M_")) {
                        hasMon = true;
                        // Strip "M_" for display
                        var displayName = name.replace(/^M_/, '');
                        btn.innerHTML = `<span class="menu-icon" style="color:#ffc107;">üìä</span><span class="menu-text">${displayName}</span>`;
                        gridMon.appendChild(btn);
                    } else {
                        hasInstr = true;
                        // Strip "I_" for display
                        var displayName = name.replace(/^I_/, '');
                        btn.innerHTML = `<span class="menu-icon" style="color:#007bff;">üìÅ</span><span class="menu-text">${displayName}</span>`;
                        gridInstr.appendChild(btn);
                    }
                });

                if(hasInstr) secInstr.style.display = 'block';
                if(hasMon) secMon.style.display = 'block';
                
                document.getElementById('status-subtitle').innerText = "Select Project"; document.getElementById('loading-overlay').style.display = 'none';
                
                var lastSheet = localStorage.getItem("bsm_last_sheet");
                if (lastSheet && names.includes(lastSheet)) { loadProject(lastSheet, true); }
            }).catch(err => { 
                document.getElementById('loading-overlay').style.display = 'none'; 
                alert("Connection Failed! Please check if deployment access is set to 'Anyone'."); 
                document.getElementById('setup-box').style.display = 'block'; 
            });
        }

        function loadProject(sheetName, isRestoring) {
            currentSheet = sheetName;
            localStorage.setItem("bsm_last_sheet", sheetName);
            document.getElementById('loading-overlay').style.display = 'flex';
            fetch(API_URL, {method: 'POST', body: JSON.stringify({action: 'get_data', sheet: sheetName})})
            .then(res => res.json()).then(data => {
                if(data.length > 0 && data[0].error) { alert(data[0].msg); return; }
                document.getElementById('home-screen').style.display = 'none'; document.getElementById('map-container').style.display = 'block';
                initMap(data, isRestoring); document.getElementById('loading-overlay').style.display = 'none'; setTimeout(() => map.invalidateSize(), 300);
            }).catch(err => { document.getElementById('loading-overlay').style.display = 'none'; alert("Failed to load map data."); });
        }

        function goHome() { 
            document.getElementById('map-container').style.display = 'none';
            document.getElementById('home-screen').style.display = 'flex'; 
            batchMode = false; measureMode = false; showZones = false; // Reset States
            updateBatchUI(); toggleMeasure(false);
            
            // Explicitly remove active classes
            document.getElementById('zone-btn').classList.remove('active');
            document.getElementById('measure-btn').classList.remove('active');
            
            if(gpsActive) toggleGPS();
            localStorage.removeItem("bsm_last_sheet");
        }
        function reloadMap() { if(currentSheet) loadProject(currentSheet, true); }

        function toggleMenu() {
            var el = document.getElementById('expandable-btns'); el.classList.toggle('show');
            var icon = document.querySelector('.btn-main-toggle'); icon.innerHTML = el.classList.contains('show') ? '‚úñ' : '‚öôÔ∏è';
        }

        function parseDateHeader(raw) {
            if(!raw) return null;
            var d = new Date(raw);
            if(isNaN(d.getTime())) return null;
            return d;
        }

        function isSameDate(d1, d2) {
             return d1.getFullYear() === d2.getFullYear() &&
                    d1.getMonth() === d2.getMonth() &&
                    d1.getDate() === d2.getDate();
        }

        function initMap(data, isRestoring) {
            if(map) map.remove();
            map = L.map('map', { rotate: true, touchRotate: true, zoomControl: false, zoomSnap: 0.1, zoomDelta: 0.5, wheelPxPerZoomLevel: 120, maxZoom: 24 });
            var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 24, maxNativeZoom: 19 });
            var satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 24, maxNativeZoom: 19 });
            osmLayer.addTo(map);
            L.control.layers({"Standard": osmLayer, "Satellite": satLayer}).addTo(map);
            L.control.zoom({position: 'bottomright'}).addTo(map);
            measureLayerGroup.addTo(map); zoneLayerGroup.addTo(map);
            
            map.on('moveend', function() { var c = map.getCenter(); var z = map.getZoom(); localStorage.setItem("bsm_map_center", JSON.stringify([c.lat, c.lng])); localStorage.setItem("bsm_map_zoom", z); });
            map.on('click', function(e) { if (measureMode) { addMeasurePoint(e.latlng); map.closePopup(); } });

            var bounds = L.latLngBounds();
            var uZones = new Set(), uTypes = new Set(), uFreq = new Set();
            markers = [];

            var isMonitoringMode = currentSheet.startsWith("M_");
            
            var dateHeaders = [];
            var today = new Date();
            today.setHours(0,0,0,0);

            if (isMonitoringMode) {
                var headerRowObj = data.find(d => d.rIdx === 1);
                if (headerRowObj && headerRowObj.mData) {
                    dateHeaders = headerRowObj.mData.map(raw => parseDateHeader(raw));
                }
            }

            data.forEach(p => {
                if (p.rIdx === 1 && isMonitoringMode) return; 

                uZones.add(p.z || "Other");
                if (controlTypes.has(p.t)) uTypes.add("Control Point"); else uTypes.add(p.t || "Other");
                if (p.freq) uFreq.add(p.freq);
                
                var finalN, finalE, isAsBuilt = false;
                if (p.an && p.ae && !isNaN(p.an) && !isNaN(p.ae)) { finalN = p.an; finalE = p.ae; isAsBuilt = true; }
                else if (p.pn && p.pe && !isNaN(p.pn) && !isNaN(p.pe)) { finalN = p.pn; finalE = p.pe; }
                else { return; }

                var lat = 0, lng = 0;
                try {
                    var wgs = proj4("EPSG:2326", "EPSG:4326", [finalE, finalN]);
                    lat = wgs[1]; lng = wgs[0];
                } catch(e) { return; }

                bounds.extend([lat, lng]);

                var isControl = controlTypes.has(p.t);
                var isDamaged = p.dmg === true;
                var color, statusStr;

                if (isMonitoringMode) {
                    color = monColorMissing; 
                    statusStr = "Missing";
                    
                    var vCount = 0;
                    var hasTodayV = false;
                    
                    if (p.mData) {
                        for(var i=0; i<p.mData.length; i++) {
                            var val = String(p.mData[i]).toLowerCase();
                            var isV = (val === 'v');
                            if(isV) vCount++;
                            if (dateHeaders[i] && isSameDate(dateHeaders[i], today)) {
                                if(isV) hasTodayV = true;
                            }
                        }
                    }
                    
                    var freq = String(p.freq).toLowerCase();
                    if (freq === "daily") {
                        if (hasTodayV) { color = monColorDone; statusStr = "Done"; }
                    } else if (freq === "weekly") {
                        if (vCount >= 1) { color = monColorDone; statusStr = "Done"; }
                    } else if (freq === "twice a week") {
                        if (vCount >= 2) { color = monColorDone; statusStr = "Done"; }
                        else if (vCount === 1) { color = monColorPartial; statusStr = "Partial"; }
                    }
                } else {
                    var hasInstallDate = (p.d && p.d.trim() !== "");
                    var hasInitDate = (p.init && p.init.trim() !== "");
                    color = colorNotInstalled; 
                    statusStr = "Not Installed";

                    if (hasInitDate) { color = colorMonitoring; statusStr = "Monitoring"; }
                    else if (hasInstallDate) { color = colorInstalled; statusStr = "Installed"; }
                    
                    if (isControl) { statusStr = "Control"; color = "#FF0000"; }
                }

                if (isDamaged) { statusStr = "Damaged"; color = "red"; }
                
                var marker;
                if (isDamaged) {
                    var xIcon = L.divIcon({ className: 'damaged-icon', html: '‚úñÔ∏é', iconSize: [16, 16], iconAnchor: [8, 8] });
                    marker = L.marker([lat, lng], { icon: xIcon });
                }
                else if (isControl) {
                    var triIcon = L.divIcon({ className: '', html: '<div class="triangle-icon"></div>', iconSize: [16, 16], iconAnchor: [8, 8] });
                    marker = L.marker([lat, lng], { icon: triIcon });
                } else {
                    var r = isAsBuilt ? 8 : 7; 
                    var opts = { radius: r, fillColor: color, color: 'white', weight: 2, fillOpacity: 1 };
                    if (isAsBuilt) { opts.color = 'black'; opts.dashArray = '5, 5'; }
                    marker = L.circleMarker([lat, lng], opts);
                }
                
                var lblClass = isAsBuilt ? 'asbuilt-label' : 'blue-label';
                marker.bindTooltip(String(p.id), { permanent: true, direction: 'top', offset: [0, 5], className: lblClass });
                marker.bindPopup("Loading...");

                marker.on('click', function(e) {
                    if (measureMode) { e.target.closePopup(); addMeasurePoint(e.latlng); } 
                    else if (batchMode) { 
                        e.target.closePopup(); 
                        toggleBatchSelection(p.id); 
                    } 
                    else { var currentM = markers.find(x => x.id === String(p.id)); if(currentM) e.target.setPopupContent(generatePopupHtml(currentM)); }
                });

                markers.push({ 
                    id: String(p.id), zone: String(p.z||"Other"), type: String(p.t||"Other"), 
                    status: statusStr, isControl: isControl, isDamaged: isDamaged, color: color,
                    layer: marker, installDate: p.d || '-', initDate: p.init || '-', 
                    code: p.code, rl: p.rl, lat: lat, lng: lng, n: finalN, e: finalE, isAsBuilt: isAsBuilt,
                    remark: p.rmk || "", freq: p.freq || "None"
                });
            });

            if (isRestoring) {
                var savedCenter = localStorage.getItem("bsm_map_center");
                var savedZoom = localStorage.getItem("bsm_map_zoom");
                if (savedCenter && savedZoom) { try { map.setView(JSON.parse(savedCenter), parseFloat(savedZoom)); } catch(e) { if(markers.length > 0) map.fitBounds(bounds.pad(0.1)); } } 
                else { if(markers.length > 0) map.fitBounds(bounds.pad(0.1)); }
            } else { if(markers.length > 0) map.fitBounds(bounds.pad(0.1)); }

            // Point 4: Custom Filter Status based on Mode
            setupMultiFilters(uZones, uTypes, uFreq, isMonitoringMode);
            updateLegend(isMonitoringMode);
            applyFilter();
            
            // Point 2: Ensure OFF by default (don't call drawZoneBoundaries here automatically)
        }

        // --- Legend Update ---
        function updateLegend(isMon) {
            var el = document.getElementById('legend-box');
            if(isMon) {
                el.innerHTML = `
                <div class="legend-icon"><span class="legend-dot" style="background:${monColorMissing};"></span></div><div class="legend-text">Missing</div>
                <div class="legend-icon"><span class="legend-dot" style="background:${monColorPartial};"></span></div><div class="legend-text">Partial</div>
                <div class="legend-icon"><span class="legend-dot" style="background:${monColorDone};"></span></div><div class="legend-text">Done</div>
                <div class="legend-icon"><span style="color:red;font-weight:900;font-size:12px;">‚úñÔ∏é</span></div><div class="legend-text">Damaged</div>`;
            } else {
                el.innerHTML = `
                <div class="legend-icon"><span class="legend-dot" style="background:red;"></span></div><div class="legend-text">Not Installed</div>
                <div class="legend-icon"><span class="legend-dot" style="background:#00e600;"></span></div><div class="legend-text">Installed</div>
                <div class="legend-icon"><span class="legend-dot" style="background:#fd7e14;"></span></div><div class="legend-text">Monitoring</div>
                <div class="legend-icon"><span style="color:red;font-weight:900;font-size:12px;">‚úñÔ∏é</span></div><div class="legend-text">Damaged</div>
                <div class="legend-separator"></div>
                <div class="legend-icon"><span style="font-size:12px;">üî∫</span></div><div class="legend-text">Control</div>
                <div class="legend-separator"></div>
                <div class="legend-icon"><span class="legend-dot" style="background:transparent; border: 2px dashed black;"></span></div><div class="legend-text">As-built</div>`;
            }
        }

        function toggleZoneBoundaries() { 
            showZones = !showZones; 
            var btn = document.getElementById('zone-btn'); 
            if (showZones) { 
                btn.classList.add('active'); 
                drawZoneBoundaries(); // Calc and draw on demand
                map.addLayer(zoneLayerGroup); 
            } else { 
                btn.classList.remove('active'); 
                map.removeLayer(zoneLayerGroup); 
            } 
        }

        function getZoneColor(zoneStr) { var hash = 0; for (var i = 0; i < zoneStr.length; i++) hash = zoneStr.charCodeAt(i) + ((hash << 5) - hash); return distinctColors[Math.abs(hash) % distinctColors.length]; }
        function calculateCentroid(points) { var latSum = 0, lngSum = 0; points.forEach(p => { latSum += p.lat; lngSum += p.lng; }); return [latSum / points.length, lngSum / points.length]; }
        function drawZoneBoundaries() { 
            zoneLayerGroup.clearLayers(); 
            var uniqueZones = new Set(); 
            markers.forEach(m => { if(m.zone && m.zone !== "Other") uniqueZones.add(m.zone); }); 
            uniqueZones.forEach(z => { 
                var points = []; 
                markers.forEach(m => { if (m.zone === z || m.zone.indexOf(z + '/') === 0) { points.push({lat: m.lat, lng: m.lng}); } }); 
                if (points.length < 3) return; 
                var hull = convexHull(points); 
                var latlngs = hull.map(p => [p.lat, p.lng]); 
                var color = getZoneColor(z); 
                L.polygon(latlngs, { color: color, weight: 4, opacity: 0.9, fillColor: color, fillOpacity: 0.15, interactive: false }).addTo(zoneLayerGroup); 
                var centroid = calculateCentroid(points); 
                var labelText = z.toString().toLowerCase().includes('zone') ? z : 'Zone ' + z; 
                var labelIcon = L.divIcon({ className: 'zone-label-icon', html: `<div class="zone-label-text" style="color:${color};border-color:${color}">${labelText}</div>`, iconSize: [0, 0], iconAnchor: [0, 0] }); 
                L.marker(centroid, {icon: labelIcon, zIndexOffset: 10000, interactive: false}).addTo(zoneLayerGroup); 
            }); 
        }
        function convexHull(points) { var pts = points.slice(); pts.sort((a, b) => a.lat != b.lat ? a.lat - b.lat : a.lng - b.lng); var lower = []; for (var i = 0; i < pts.length; i++) { while (lower.length >= 2 && crossProduct(lower[lower.length - 2], lower[lower.length - 1], pts[i]) <= 0) { lower.pop(); } lower.push(pts[i]); } var upper = []; for (var i = pts.length - 1; i >= 0; i--) { while (upper.length >= 2 && crossProduct(upper[upper.length - 2], upper[upper.length - 1], pts[i]) <= 0) { upper.pop(); } upper.push(pts[i]); } upper.pop(); lower.pop(); return lower.concat(upper); }
        function crossProduct(o, a, b) { return (a.lng - o.lng) * (b.lat - o.lat) - (a.lat - o.lat) * (b.lng - o.lng); }

        function openPrintView() { document.getElementById('print-mode-modal').style.display = 'flex'; }
        function closePrintModeModal() { document.getElementById('print-mode-modal').style.display = 'none'; }
        function loadPrintView(mode) { closePrintModeModal(); document.getElementById('print-container').style.display = 'block'; refreshPrintContent(mode); }
        function refreshPrintContent(mode) {
            var contentDiv = document.getElementById('print-content'); var dateEl = document.getElementById('print-date');
            if (!mode) mode = 'all_simplified';
            dateEl.innerText = "Generated on: " + new Date().toLocaleString(); contentDiv.innerHTML = "";
            var visibleMarkers = markers.filter(m => map.hasLayer(m.layer));
            if (mode === 'view_only') { var bounds = map.getBounds(); visibleMarkers = visibleMarkers.filter(m => bounds.contains(m.layer.getLatLng())); }
            if (visibleMarkers.length === 0) { contentDiv.innerHTML = "<div style='text-align:center;margin-top:20px;'>No points found.</div>"; return; }
            var byFreq = {}; visibleMarkers.forEach(m => { var f = m.freq || "No Frequency"; if(!byFreq[f]) byFreq[f] = []; byFreq[f].push(m); });
            Object.keys(byFreq).sort().forEach(freqName => {
                var freqPoints = byFreq[freqName];
                var freqBlock = document.createElement('div'); freqBlock.className = 'report-freq-block';
                var freqHeader = document.createElement('div'); freqHeader.className = 'report-freq-header'; freqHeader.innerText = `${freqName} (Total: ${freqPoints.length})`; freqBlock.appendChild(freqHeader);
                var byType = {}; freqPoints.forEach(p => { var t = p.type || "Other"; if(!byType[t]) byType[t] = []; byType[t].push(p.id); });
                var detailsContainer = document.createElement('div'); detailsContainer.className = 'report-details-table';
                Object.keys(byType).sort().forEach(typeName => {
                    var ids = byType[typeName].sort();
                    var row = document.createElement('div'); row.className = 'report-type-row';
                    var typeCell = document.createElement('div'); typeCell.className = 'report-type-cell'; typeCell.innerText = `${typeName} (${ids.length})`;
                    var pointsCell = document.createElement('div'); pointsCell.className = 'report-points-cell';
                    if (mode === 'all_simplified') pointsCell.innerHTML = simplifyIdList(ids);
                    else pointsCell.innerHTML = ids.map(id => `<span style="display:inline-block; white-space:nowrap;">${id}</span>`).join(', ');
                    row.appendChild(typeCell); row.appendChild(pointsCell); detailsContainer.appendChild(row);
                });
                freqBlock.appendChild(detailsContainer); contentDiv.appendChild(freqBlock);
            });
        }
        function simplifyIdList(ids) {
            if (ids.length === 0) return "";
            var groups = {}, singles = [];
            ids.forEach(id => { var match = id.match(/^(.*?)(\d+)$/); if (match) { var prefix = match[1]; var num = parseInt(match[2], 10); var digitCount = match[2].length; if (!groups[prefix]) groups[prefix] = []; groups[prefix].push({ num: num, digitCount: digitCount, original: id }); } else { singles.push(id); } });
            var results = [];
            for (var prefix in groups) {
                var items = groups[prefix].sort((a, b) => a.num - b.num);
                if (items.length === 0) continue;
                var start = items[0], prev = items[0];
                for (var i = 1; i < items.length; i++) { var curr = items[i]; if (curr.num === prev.num + 1 && curr.digitCount === prev.digitCount) { prev = curr; } else { results.push(formatRange(start, prev)); start = curr; prev = curr; } }
                results.push(formatRange(start, prev));
            }
            results.push(...singles); return results.join(', ');
        }
        function formatRange(start, end) { if (start.original === end.original) return `<span style="display:inline-block; white-space:nowrap;">${start.original}</span>`; return `<span style="display:inline-block; white-space:nowrap;">${start.original} ~ ${end.original}</span>`; }
        function closePrintView() { document.getElementById('print-container').style.display = 'none'; }

        function toggleDropdown(t) { var el = document.getElementById(t+'-dropdown'); document.querySelectorAll('.dropdown-check-list').forEach(d => { if(d!==el) d.classList.remove('visible'); }); el.classList.toggle('visible'); }
        
        // Point 4: Modified Status Filter
        function setupMultiFilters(z, t, f, isMon) { 
            populate(z, 'zone', 'Zone'); 
            populate(t, 'type', 'Type'); 
            populate(f, 'freq', 'Freq'); 
            
            var sSet;
            if (isMon) {
                sSet = new Set(['Missing', 'Partial', 'Done']);
            } else {
                sSet = new Set(['Not Installed', 'Installed', 'Monitoring', 'Damaged', 'Control']);
            }
            populate(sSet, 'status', 'Status'); 
        }

        function populate(set, type, label) { 
            var c = document.getElementById(type+'-items'); c.innerHTML=`<li class="check-label" onclick="toggleAll('${type}',this)"><input type="checkbox" id="all-${type}"><b>Select All</b></li>`; 
            var saved = localStorage.getItem('filter_' + type); var savedArr = saved ? JSON.parse(saved) : null; var allChecked = true;
            Array.from(set).sort().forEach(v => { var isChecked = savedArr ? savedArr.includes(v) : true; if(!isChecked) allChecked = false; c.innerHTML+=`<li class="check-label" onclick="updateFilter('${type}')"><input type="checkbox" class="${type}-chk" value="${v}" ${isChecked?'checked':''}>${v}</li>`; });
            document.getElementById('all-'+type).checked = allChecked; document.getElementById(type+'-dropdown').setAttribute('data-label', label); updateAnchor(type);
        }
        function toggleAll(t, el) { var chk = el.querySelector('input').checked; document.querySelectorAll('.'+t+'-chk').forEach(c=>c.checked=chk); updateFilter(t); }
        function updateFilter(t) { var chks = Array.from(document.querySelectorAll('.'+t+'-chk')); var checkedVals = chks.filter(c=>c.checked).map(c=>c.value); localStorage.setItem('filter_' + t, JSON.stringify(checkedVals)); document.getElementById('all-'+t).checked = chks.every(c=>c.checked); updateAnchor(t); applyFilter(); }
        function updateAnchor(t) { var chk = document.querySelectorAll('.'+t+'-chk:checked').length; var tot = document.querySelectorAll('.'+t+'-chk').length; var anchor = document.querySelector('#'+t+'-dropdown .anchor'); var label = document.getElementById(t+'-dropdown').getAttribute('data-label') || t; if (chk === tot) anchor.innerHTML = label + ": All"; else if (chk === 0) anchor.innerHTML = label + ": None"; else anchor.innerHTML = label + ": " + chk; }
        
        function applyFilter() {
            var s = document.getElementById('search-input').value.toUpperCase();
            var sz = Array.from(document.querySelectorAll('.zone-chk:checked')).map(c => c.value);
            var st = Array.from(document.querySelectorAll('.type-chk:checked')).map(c => c.value);
            var ss = Array.from(document.querySelectorAll('.status-chk:checked')).map(c => c.value);
            var sf = Array.from(document.querySelectorAll('.freq-chk:checked')).map(c => c.value);
            var v=[];
            markers.forEach(m => {
                var searchMatch = m.id.toUpperCase().includes(s);
                var isControl = controlTypes.has(m.type);
                if (isControl && !currentSheet.startsWith("M_")) { 
                    var typeSelected = st.includes("Control Point") || st.includes(m.type); if (typeSelected && searchMatch) { map.addLayer(m.layer); v.push(m); return; } 
                }
                if (isControl && !currentSheet.startsWith("M_")) { map.removeLayer(m.layer); return; }
                
                var typeMatch = st.includes(m.type); var zoneMatch = sz.includes(m.zone); var freqMatch = sf.includes(m.freq); var statusMatch = ss.includes(m.status);
                if (typeMatch && zoneMatch && statusMatch && freqMatch && searchMatch) { map.addLayer(m.layer); v.push(m); } else { map.removeLayer(m.layer); }
            });
            renderList(v);
        }

        function toggleBatchMode() { if (measureMode) toggleMeasure(); batchMode = !batchMode; var btn = document.getElementById('batch-toggle-btn'); var bar = document.getElementById('batch-bar'); if (batchMode) { btn.classList.add('active'); bar.style.display = 'flex'; map.closePopup(); } else { btn.classList.remove('active'); bar.style.display = 'none'; clearBatchSelection(); } }
        function updateBatchUI() { var btn = document.getElementById('batch-toggle-btn'); var bar = document.getElementById('batch-bar'); if(batchMode){ btn.classList.add('active'); bar.style.display='flex'; } else { btn.classList.remove('active'); bar.style.display='none'; } }
        function toggleBatchSelection(id) { var m = markers.find(x => x.id === id); if (!m) return; if (batchSelection.has(id)) { batchSelection.delete(id); if (m.layer.setStyle) { m.layer.setStyle({ fillColor: m.color, color: (m.id === m.zone ? 'white':'white'), weight: 2 }); } } else { batchSelection.add(id); if (m.layer.setStyle) { m.layer.setStyle({ fillColor: '#ffc107', color: 'black', weight: 4 }); } } document.getElementById('batch-count').innerText = batchSelection.size; }
        function clearBatchSelection() { batchSelection.forEach(id => { var m = markers.find(x => x.id === id); if (m && m.layer.setStyle) m.layer.setStyle({ fillColor: m.color, color: 'white', weight: 2 }); }); batchSelection.clear(); document.getElementById('batch-count').innerText = 0; }
        
        // Point 3: Batch Mode Logic (Modified)
        function openBatchInstallModal() { 
            if (batchSelection.size === 0) return; 
            isBatchInstall = true; 
            
            var isMon = currentSheet.startsWith("M_");
            document.getElementById('modal-title').innerText = isMon ? "Confirm Update" : "Batch Install";
            document.getElementById('modal-subtitle').innerText = batchSelection.size + " selected points";
            
            var dateContainer = document.getElementById('install-date-picker');
            var dateLabel = document.getElementById('date-label');
            var saveBtn = document.getElementById('modal-save-btn');
            
            var today = new Date().toISOString().split('T')[0]; 
            dateContainer.value = today; 
            
            if (isMon) {
                dateLabel.innerText = "Select Date to Mark 'v'";
                saveBtn.innerText = "Update Record (v)";
                saveBtn.onclick = saveBatchMonitoring;
            } else {
                dateLabel.innerText = "Install Date";
                saveBtn.innerText = "Save";
                saveBtn.onclick = saveInstall;
            }
            
            document.getElementById('update-modal-overlay').style.display = 'flex'; 
        }

        function saveBatchMonitoring() {
             var dateInput = document.getElementById('install-date-picker').value;
             if(!dateInput) { alert("Please select a date"); return; }
             
             document.getElementById('loading-overlay').style.display = 'flex';
             var ids = Array.from(batchSelection);
             
             // Optimistic UI Update
             ids.forEach(id => {
                 var m = markers.find(x=>x.id===id);
                 if(m) {
                    m.status = "Done"; m.color = monColorDone;
                    if(m.layer.setStyle) m.layer.setStyle({fillColor:monColorDone});
                    updatePopupContent(m);
                 }
             });
             renderList(markers);
             
             fetch(API_URL, {
                method: 'POST', body: JSON.stringify({action: 'batch_update_monitoring', sheet: currentSheet, ids: ids, date: dateInput})
             }).then(res => res.text()).then(txt => {
                 alert(txt); toggleBatchMode(); reloadMap(); 
             }).catch(err => { alert("Error"); document.getElementById('loading-overlay').style.display = 'none'; });
             
             closeModal();
        }

        function toggleMeasure() { if (batchMode) toggleBatchMode(); measureMode = !measureMode; var btn = document.getElementById('measure-btn'); var box = document.getElementById('measure-box'); if (measureMode) { btn.classList.add('active'); box.style.display = 'block'; map.closePopup(); map.getContainer().style.cursor = 'crosshair'; } else { btn.classList.remove('active'); box.style.display = 'none'; clearMeasure(); map.getContainer().style.cursor = ''; } }
        function addMeasurePoint(latlng) { measurePoints.push(latlng); redrawMeasure(); calculateMeasure(); }
        function undoMeasure() { if(measurePoints.length > 0) { measurePoints.pop(); redrawMeasure(); calculateMeasure(); } }
        function clearMeasure() { measurePoints = []; measureLayerGroup.clearLayers(); document.getElementById('measure-dist').innerText = "Dist: 0.00 m"; }
        function redrawMeasure() { measureLayerGroup.clearLayers(); if(measurePoints.length === 0) return; measurePoints.forEach(pt => { L.circleMarker(pt, {color: 'black', fillColor: 'white', radius: 4, fillOpacity: 1}).addTo(measureLayerGroup); }); if (measurePoints.length > 1) { L.polyline(measurePoints, {color: 'black', dashArray: '5, 5', weight: 2}).addTo(measureLayerGroup); } }
        function calculateMeasure() { if (measurePoints.length < 2) { document.getElementById('measure-dist').innerText = "Dist: 0.00 m"; return; } var totalDist = 0; for (var i = 0; i < measurePoints.length - 1; i++) { totalDist += measurePoints[i].distanceTo(measurePoints[i+1]); } document.getElementById('measure-dist').innerText = "Dist: " + totalDist.toFixed(2) + " m"; }

        function toggleDamaged(id, isMarkingDamaged) { if(!confirm(isMarkingDamaged ? "Mark as DAMAGED?" : "Reinstate (Fix) this point?")) return; document.getElementById('loading-overlay').style.display = 'flex'; fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'toggle_damaged', sheet: currentSheet, id: id, status: (isMarkingDamaged?'damaged':'fixed')}) }).then(res => res.text()).then(txt => { reloadMap(); }); }

        var gpsActive = false; var gpsWatchId = null; var currentHeading = 0;
        function handleOrientation(event) { var heading = null; if (event.webkitCompassHeading) { heading = event.webkitCompassHeading; } else if (event.alpha !== null) { heading = 360 - event.alpha; } if (heading !== null) { heading = (heading + 360) % 360; currentHeading = heading; var beam = document.querySelector('.location-beam'); if (beam) { beam.style.display = 'block'; beam.style.transform = `rotate(${heading}deg)`; } if(gpsActive) updateGPSBoxContent(); } }
        if (window.DeviceOrientationEvent) { window.addEventListener("deviceorientation", handleOrientation, true); window.addEventListener("deviceorientationabsolute", handleOrientation, true); }
        function updateGPSBoxContent(lat, lon, acc) { var box = document.getElementById('gps-coords-box'); var content = ""; if (lat !== undefined && lon !== undefined) { try { if (typeof proj4 !== 'undefined') { var result = proj4("EPSG:4326", "EPSG:2326", [lon, lat]); content += `N: ${result[1].toFixed(3)} | E: ${result[0].toFixed(3)}`; if(acc) content += ` <br><small>Á≤æÂ∫¶: ¬±${Math.round(acc)}m</small>`; } else { content += `Lat: ${lat.toFixed(5)} | Lon: ${lon.toFixed(5)}`; } } catch(e) { content += `Lat: ${lat.toFixed(5)} | Lon: ${lon.toFixed(5)}`; } box.setAttribute('data-last-pos', content); } else { content = box.getAttribute('data-last-pos') || "Waiting..."; } if (currentHeading !== null && !isNaN(currentHeading)) { var h = currentHeading; var dirStr = ""; if (h >= 337.5 || h < 22.5) dirStr = "N"; else if (h >= 22.5 && h < 67.5) dirStr = "NE"; else if (h >= 67.5 && h < 112.5) dirStr = "E"; else if (h >= 112.5 && h < 157.5) dirStr = "SE"; else if (h >= 157.5 && h < 202.5) dirStr = "S"; else if (h >= 202.5 && h < 247.5) dirStr = "SW"; else if (h >= 247.5 && h < 292.5) dirStr = "W"; else if (h >= 292.5 && h < 337.5) dirStr = "NW"; content += ` | ‚¨Ü ${Math.round(h)}¬∞ (${dirStr})`; } box.innerHTML = content; }
        function toggleGPS() { var gpsBtn = document.getElementById('gps-btn'); var gpsBox = document.getElementById('gps-coords-box'); if (!gpsActive) { if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') { DeviceOrientationEvent.requestPermission().then(resp => { if(resp=='granted'){} }).catch(console.error); } if ("geolocation" in navigator) { gpsBtn.classList.add('active'); gpsBox.style.display = 'block'; gpsBox.innerHTML = "Ê≠£Âú®Áç≤ÂèñË°õÊòüË®äËôü..."; gpsActive = true; gpsWatchId = navigator.geolocation.watchPosition( function(position) { var lat = position.coords.latitude; var lon = position.coords.longitude; var acc = position.coords.accuracy; var latlng = [lat, lon]; if (!userMarker) { var beamIcon = L.divIcon({ className: 'user-location-marker', html: '<div class="location-beam"></div><div class="location-dot"></div>', iconSize: [40, 40], iconAnchor: [20, 20] }); userMarker = L.marker(latlng, {icon: beamIcon, zIndexOffset: 1000}).addTo(map); } else { userMarker.setLatLng(latlng); } map.setView(latlng); updateGPSBoxContent(lat, lon, acc); }, function(error) { gpsBox.innerHTML = "GPS Error: " + error.message; }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } ); } else { alert("ÁÄèË¶ΩÂô®‰∏çÊîØÊåÅ GPS"); } } else { if(gpsWatchId !== null) navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; gpsBtn.classList.remove('active'); gpsBox.style.display = 'none'; gpsActive = false; if(userMarker) map.removeLayer(userMarker); userMarker = null; } }

        function openInstallModal(id) { isBatchInstall = false; currentEditingId = id; document.getElementById('modal-title').innerText = "Update Install Date"; document.getElementById('modal-subtitle').innerText = id; document.getElementById('date-label').innerText="Install Date"; var saveBtn=document.getElementById('modal-save-btn'); saveBtn.innerText='Save'; saveBtn.onclick=saveInstall; var today = new Date().toISOString().split('T')[0]; document.getElementById('install-date-picker').value = today; document.getElementById('update-modal-overlay').style.display = 'flex'; }
        function closeModal() { document.getElementById('update-modal-overlay').style.display = 'none'; currentEditingId = null; isBatchInstall = false; }
        function saveInstall() { var d = document.getElementById('install-date-picker').value; if(!d) { alert("Please select date"); return; } if (isBatchInstall) { submitBatchInstallData(d); } else { if(!currentEditingId) return; updateStatus(currentEditingId, d); } closeModal(); }
        function updateStatus(id, dateStr) { var m = markers.find(x => x.id === id); if(m) { m.status = "Installed"; m.color = colorInstalled; m.installDate = dateStr; if(m.layer.setStyle) m.layer.setStyle({fillColor: colorInstalled}); updatePopupContent(m); } fetch(API_URL, {method:'POST', body:JSON.stringify({action:'update', sheet:currentSheet, id:id, status:1, date:dateStr})}).catch(err => alert("Update Error (Background)")); }
        
        function openInitialModal(id) { currentEditingId = id; document.getElementById('initial-modal-subtitle').innerText = "ID: " + id; var today = new Date().toISOString().split('T')[0]; document.getElementById('initial-date-picker').value = today; document.getElementById('initial-modal-overlay').style.display = 'flex'; }
        function closeInitialModal() { document.getElementById('initial-modal-overlay').style.display = 'none'; currentEditingId = null; }
        function saveInitial() { var dateInput = document.getElementById('initial-date-picker').value; if (!dateInput) { alert("Please select date"); return; } document.getElementById('loading-overlay').style.display = 'flex'; var id = currentEditingId; var m = markers.find(x => x.id === id); if(m) { m.initDate = dateInput; m.status = "Monitoring"; m.color = colorMonitoring; if(m.layer.setStyle) m.layer.setStyle({fillColor: colorMonitoring}); updatePopupContent(m); } fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'update_initial', sheet: currentSheet, id: id, date: dateInput}) }).then(res => res.text()).then(txt => { document.getElementById('loading-overlay').style.display = 'none'; }).catch(err => { alert("Update Failed"); document.getElementById('loading-overlay').style.display = 'none'; }); closeInitialModal(); }

        function generatePopupHtml(m) {
            var navLink = `<a href="https://www.google.com/maps/dir/?api=1&destination=${m.lat},${m.lng}" target="_blank" title="Navigate" style="text-decoration:none; font-size:16px; margin-left: 8px;">üöÄ</a>`;
            var content = `<div style="font-weight:bold;font-size:16px; display: flex; align-items: center;">${m.id}${navLink}</div><div style="font-size:13px;color:#555;">Code: <b>${m.code || '-'}</b></div><div style="font-size:12px;color:#555;">N: ${m.n} | E: ${m.e}</div><div style="font-size:12px;color:#555;">Zone: ${m.zone} | Type: ${m.type}</div>`;
            if (m.isAsBuilt) content += `<div style="color:blue; text-shadow: 1px 1px 0 #00FF00; font-weight:bold; font-size:12px;">(As-built Pos.)</div>`;
            if (m.freq && m.freq !== "None") content += `<div style="font-size:12px;color:#007bff;">Freq: <b>${m.freq}</b></div>`;
            if (m.isControl) { content += `<div style="margin-top:5px;font-weight:bold;color:#333;">RL: ${m.rl || '-'}</div>`; return content; }
            
            var btnHtml = "";
            if(m.isDamaged) {
                 btnHtml = `<button onclick="toggleDamaged('${m.id}', false)" style="width:100%;background:#28a745;color:white;border:none;padding:8px;border-radius:4px;cursor:pointer;margin-top:10px;">Reinstate (Fix)</button>`;
            } else if (!currentSheet.startsWith("M_")) {
                 var hasInstall = (m.installDate && m.installDate !== "-" && m.installDate !== "");
                 var hasInit = (m.initDate && m.initDate !== "-" && m.initDate !== "");
                 if (!hasInstall) {
                     btnHtml = `<button onclick="openInstallModal('${m.id}')" style="width:100%;background:#007bff;color:white;border:none;padding:8px;border-radius:4px;cursor:pointer;margin-top:10px;">Confirm Install</button>`;
                 } else if (hasInstall && !hasInit) {
                     btnHtml = `<button onclick="openInitialModal('${m.id}')" style="width:100%;background:#e67e22;color:white;border:none;padding:8px;border-radius:4px;cursor:pointer;margin-top:10px;">Input Initial Date</button>`;
                 } else {
                     btnHtml = `<button disabled style="width:100%;background:#ccc;border:none;padding:8px;border-radius:4px;margin-top:10px;">Locked</button>`;
                 }
            } else {
                 btnHtml = "";
            }

            var dmgBtn = !m.isDamaged ? `<div style="text-align:right;margin-top:5px;"><small style="color:red;cursor:pointer;text-decoration:underline;" onclick="toggleDamaged('${m.id}', true)">Report Damaged</small></div>` : "";
            var rmkBtn = `<div style="text-align:right;margin-top:2px;"><small style="color:#007bff;cursor:pointer;text-decoration:underline;" onclick="openRemarkModal('${m.id}')">[Remark]</small></div>`;
            var remarkDisplay = "";
            if (m.remark && m.remark.trim() !== "") { remarkDisplay = `<div style="margin-top:5px;color:purple;font-size:12px;font-weight:bold;border-top:1px dashed #ccc;padding-top:2px;">Remark: ${m.remark}</div>`; }

            content += `<div style="margin-top:8px;border-top:1px solid #eee;padding-top:5px;">Status: <b style="color:${m.color}">${m.status}</b></div><div style="font-size:11px;color:#777;">Install: ${m.installDate}</div><div style="font-size:11px;color:#777;">Initial: ${m.initDate}</div>${remarkDisplay}${btnHtml}${dmgBtn}${rmkBtn}`;
            return content;
        }

        function updatePopupContent(m) { var newContent = generatePopupHtml(m); if (m.layer.getPopup()) { m.layer.setPopupContent(newContent); } }
        function openRemarkModal(id) { currentEditingId = id; document.getElementById('remark-subtitle').innerText = "ID: " + id; var m = markers.find(x=>x.id===id); document.getElementById('remark-input').value = m ? m.remark : ""; document.getElementById('remark-modal-overlay').style.display = 'flex'; }
        function closeRemarkModal() { document.getElementById('remark-modal-overlay').style.display = 'none'; currentEditingId = null; }
        function saveRemark() { if(!currentEditingId) return; var txt = document.getElementById('remark-input').value; document.getElementById('loading-overlay').style.display = 'flex'; var m = markers.find(x=>x.id===currentEditingId); if(m) { m.remark = txt; updatePopupContent(m); } fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'save_remark', sheet: currentSheet, id: currentEditingId, remark: txt}) }).then(res => res.text()).then(resp => { alert(resp); document.getElementById('loading-overlay').style.display = 'none'; closeRemarkModal(); }).catch(err => { alert("Error saving remark"); document.getElementById('loading-overlay').style.display = 'none'; }); }

        function renderList(items) { var c = document.getElementById('list-container'); c.innerHTML=''; items.forEach(m=>{ var el=document.createElement('div'); el.className='list-item'; var zc= getZoneColor(m.zone); var iconHtml; if(m.isDamaged) iconHtml = '<span style="color:red;font-weight:bold;">‚úñ</span>'; else if(m.isControl) iconHtml = '<div class="triangle-icon"></div>'; else iconHtml = `<span class="status-dot" style="background:${m.color}"></span>`; el.innerHTML=`<div style="display:flex; align-items:center;">${iconHtml} <b>${m.id}</b></div><div><span style="font-size:11px;background:#eee;padding:2px 5px;border-radius:4px;margin-right:5px;">${m.type}</span><span style="font-size:11px;background:${zc};color:white;padding:2px 5px;border-radius:10px;">${m.zone}</span></div>`; el.onclick=()=>{ map.flyTo(m.layer.getLatLng(),18); var popupHtml = generatePopupHtml(m); m.layer.setPopupContent(popupHtml); m.layer.openPopup(); if(window.innerWidth<600)toggleSidebar(false);}; c.appendChild(el); }); }
        function toggleSidebar(f) { var s=document.getElementById('sidebar'); if(f!==undefined) f?s.classList.add('open'):s.classList.remove('open'); else s.classList.toggle('open'); }
        
        function submitBatchInstallData(dateStr) { document.getElementById('loading-overlay').style.display = 'flex'; var ids = Array.from(batchSelection); ids.forEach(id => { var m = markers.find(x=>x.id===id); if(m) { m.status = "Installed"; m.color = colorInstalled; m.installDate = dateStr; if(m.layer.setStyle) m.layer.setStyle({fillColor:colorInstalled}); updatePopupContent(m); } }); renderList(markers); fetch(API_URL, { method: 'POST', body: JSON.stringify({action: 'batch_install', sheet: currentSheet, ids: ids, date: dateStr}) }).then(res => res.text()).then(txt => { alert(txt); toggleBatchMode(); reloadMap(); }).catch(err => { alert("Error"); document.getElementById('loading-overlay').style.display = 'none'; }); }
    </script>
</body>
</html>
